<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Caretaker Dashboard</title>
  <link rel="stylesheet" href="/Caretaker/caretaker.css" />
  <link rel="stylesheet" href="/Admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
  /* ‚Äî‚Äî‚Äî Layout containers ‚Äî‚Äî‚Äî */
  .ct-hero{display:flex;align-items:end;justify-content:space-between;gap:16px;margin-bottom:12px}
  .ct-title{margin:0;font-size:1.6rem}
  .ct-sub{margin:2px 0 0;color:#6b7280}
  .ct-quick{display:flex;gap:8px;flex-wrap:wrap}

  /* Buttons */
  .ct-btn{background:#1a7f37;color:#fff;border:1px solid #1a7f37;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  .ct-btn.ghost{background:#fff;color:#1a7f37}
  .ct-btn i{margin-right:6px}

  /* KPIs */
  .ct-kpis{display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:14px;margin:14px 0 6px}
  .kpi{background:#fff;border:1px solid #eef2f6;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(16,24,40,.06)}
  .kpi-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .kpi-label{font-weight:800;color:#111827}
  .kpi-num{font-size:2rem;font-weight:800;line-height:1;margin:4px 0}
  .kpi-sub{color:#6b7280;font-size:.9rem}
  .kpi-chip{border:1px solid #e5e7eb;background:#f9fafb;padding:2px 8px;border-radius:999px;font-weight:800;font-size:.75rem}
  .kpi-chip.info{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
  .kpi-chip.success{background:#ecfdf3;border-color:#bbf7d0;color:#065f46}
  .kpi-chip.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}

  /* Content blocks */
  .ct-block{background:#fff;border:1px solid #eef2f6;border-radius:14px;padding:16px;margin-top:14px;box-shadow:0 6px 16px rgba(16,24,40,.06)}
  .ct-block-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .ct-block-head h2{font-size:1.05rem;margin:0;display:flex;gap:8px;align-items:center}
  .ct-head-right{color:#6b7280}

  /* Timeline */
  .ct-timeline{display:flex;flex-direction:column;gap:8px}
  .tl-item{display:flex;gap:10px;align-items:flex-start;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .tl-time{min-width:84px;font-weight:800;color:#111827}
  .tl-body{flex:1}
  .tl-meta{display:flex;gap:8px;flex-wrap:wrap;color:#6b7280;font-size:.9rem;margin-top:4px}
  .pill{background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 8px;border-radius:999px}
  .pill.info{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
  .pill.success{background:#ecfdf3;border-color:#bbf7d0;color:#065f46}
  .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}

  /* Queue */
  .ct-tabs{display:flex;gap:6px}
  .ct-tabs .tab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
  .ct-tabs .tab.active{background:#1a7f37;color:#fff;border-color:#1a7f37}
  .ct-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .q-card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff;box-shadow:0 6px 16px rgba(16,24,40,.06);display:flex;flex-direction:column;gap:8px}
  .q-head{display:flex;justify-content:space-between;align-items:center}
  .q-title{font-weight:800}
  .q-meta{display:flex;gap:8px;flex-wrap:wrap;color:#6b7280;font-size:.9rem}
  .q-actions{display:flex;gap:8px}
  .q-btn{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
  .q-btn.primary{background:#1a7f37;color:#fff;border-color:#1a7f37}
  .q-card.warn{border-color:#fed7aa}
  .q-card.info{border-color:#bfdbfe}
  .q-card.success{border-color:#bbf7d0}

  /* Sow mini cards */
  .ct-mini-cards{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
  .mini{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px}
  .mini.warn{border-color:#fecaca}
  .mini-label{color:#6b7280;font-size:.9rem}
  .mini-num{display:block;font-size:1.4rem;font-weight:800;margin-top:2px}

  /* Alerts & tasks & activity */
  .ct-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .ct-alert{border:1px solid #e5e7eb;border-left:4px solid #eab308;background:#fffbeb;border-radius:10px;padding:10px}
  .ct-tasks li{display:flex;justify-content:space-between;align-items:center;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;margin-bottom:8px}
  .task-due{color:#6b7280;font-size:.9rem}
  .ct-activity .act{display:flex;gap:8px;margin-bottom:8px}
  .act-time{min-width:88px;color:#6b7280}

  .ct-empty{color:#6b7280;padding:8px 0}
  @media (max-width: 980px){ .ct-kpis{grid-template-columns:repeat(2,1fr)} .ct-mini-cards{grid-template-columns:repeat(2,1fr)} .ct-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-caretaker.html" class="active"><i class="fa-solid fa-clipboard-list"></i> User Dashboard</a>
      <a href="caretaker-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="caretaker-manage-pig-records.html"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="caretaker-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedules</a>
      <a href="#" id="logout" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main -->
<main class="dashboard">
  <!-- HERO -->
  <div class="ct-hero">
    <div>
      <h1 class="ct-title">Caretaker Dashboard</h1>
      <p class="ct-sub">Your shift at a glance.</p>
    </div>
    <div class="ct-quick">
      <button class="ct-btn ghost" id="btn-log-feeding"><i class="fa-solid fa-bowl-food"></i> Log a Feeding</button>
      <button class="ct-btn ghost" id="btn-health-check"><i class="fa-solid fa-stethoscope"></i> Record Health Check</button>
      <button class="ct-btn ghost" id="btn-view-sched"><i class="fa-solid fa-clock"></i> View Today‚Äôs Schedule</button>
    </div>
  </div>

  <!-- KPI ROW -->
  <section class="ct-kpis">
    <div class="kpi">
      <div class="kpi-top">
        <span class="kpi-label">Due Now</span>
        <span class="kpi-chip info" id="kpi-due-trend">‚Äî</span>
      </div>
      <div class="kpi-num" id="kpi-due">‚Äî</div>
      <div class="kpi-sub">within the next hour</div>
    </div>

    <div class="kpi">
      <div class="kpi-top">
        <span class="kpi-label">Completed Today</span>
        <span class="kpi-chip success" id="kpi-done-trend">‚Äî</span>
      </div>
      <div class="kpi-num" id="kpi-done">‚Äî</div>
      <div class="kpi-sub">feeding logs</div>
    </div>

    <div class="kpi">
      <div class="kpi-top">
        <span class="kpi-label">Overdue</span>
        <span class="kpi-chip warn" id="kpi-overdue-trend">‚Äî</span>
      </div>
      <div class="kpi-num" id="kpi-overdue">‚Äî</div>
      <div class="kpi-sub">past due tasks</div>
    </div>

    <div class="kpi">
      <div class="kpi-top">
        <span class="kpi-label">Sows to Tend</span>
        <span class="kpi-chip" id="kpi-sows-trend" style="visibility:hidden;">‚Äî</span>
      </div>
      <div class="kpi-num" id="kpi-sows">‚Äî</div>
      <div class="kpi-sub">active sows</div>
    </div>
  </section>

  <!-- TODAY'S SCHEDULE -->
  <section class="ct-block">
    <div class="ct-block-head">
      <h2><i class="fa-solid fa-timeline"></i> Today‚Äôs Schedule</h2>
      <div class="ct-head-right" id="shiftLabel">Shift ‚Äî</div>
    </div>
    <div class="ct-timeline" id="timeline">
      <!-- populated by JS -->
    </div>
    <div class="ct-empty" id="emptyTimeline" hidden>No scheduled feedings for the next 4 hours.</div>
  </section>

  <!-- FEEDING QUEUE -->
  <section class="ct-block">
    <div class="ct-block-head">
      <h2><i class="fa-solid fa-list-check"></i> Feeding Queue</h2>
      <div class="ct-tabs">
        <button class="tab active" data-qtab="due">Due Now</button>
        <button class="tab" data-qtab="today">All Today</button>
      </div>
    </div>
    <div class="ct-cards" id="queueCards">
      <!-- populated by JS -->
    </div>
    <div class="ct-empty" id="emptyQueue" hidden>No items in this queue.</div>
  </section>

  <!-- SOW STATUS -->
  <section class="ct-block">
    <div class="ct-block-head">
      <h2><i class="fa-solid fa-venus"></i> Sow Status at a Glance</h2>
    </div>
    <div class="ct-mini-cards" id="sowStats">
      <div class="mini"><span class="mini-label">Pregnant</span><span class="mini-num" id="stat-pregnant">‚Äî</span></div>
      <div class="mini"><span class="mini-label">Due this week</span><span class="mini-num" id="stat-due">‚Äî</span></div>
      <div class="mini warn"><span class="mini-label">Overdue</span><span class="mini-num" id="stat-overdue">‚Äî</span></div>
      <div class="mini"><span class="mini-label">Nursing</span><span class="mini-num" id="stat-nursing">‚Äî</span></div>
    </div>
  </section>

  <!-- ALERTS & TASKS -->
  <section class="ct-grid">
    <div class="ct-block">
      <div class="ct-block-head">
        <h2><i class="fa-solid fa-bell"></i> Alerts</h2>
      </div>
      <div class="ct-alerts" id="alerts">
        <!-- populated by JS -->
      </div>
      <div class="ct-empty" id="emptyAlerts" hidden>No alerts üéâ</div>
    </div>

    <div class="ct-block">
      <div class="ct-block-head">
        <h2><i class="fa-solid fa-square-check"></i> Tasks</h2>
      </div>
      <ul class="ct-tasks" id="tasks">
        <!-- demo placeholders (you can wire to backend later) -->
        <li><label><input type="checkbox"> Sanitize pen P-12</label><span class="task-due">Today 5:00 PM</span></li>
        <li><label><input type="checkbox"> Recount feed stock (Grower)</label><span class="task-due">Today 6:00 PM</span></li>
      </ul>
    </div>
  </section>

  <!-- RECENT ACTIVITY -->
  <section class="ct-block">
    <div class="ct-block-head">
      <h2><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h2>
    </div>
    <div class="ct-activity" id="activity">
      <!-- populated by JS -->
    </div>
    <div class="ct-empty" id="emptyActivity" hidden>No activity yet today.</div>
  </section>
</main>


<script>
  /* =======================
     Config & helpers
  ======================= */
  const API_BASE = "http://localhost:8000/api";
  const token = localStorage.getItem("auth_token") || localStorage.getItem("token") || localStorage.getItem("access_token");

  const headers = () => ({
    "Accept": "application/json",
    "Content-Type": "application/json",
    ...(token ? { "Authorization": `Bearer ${token}` } : {})
  });

  const todayStr = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };
  // === Wire quick-action buttons ===
const btnLogFeeding  = document.getElementById('btn-log-feeding');
const btnHealthCheck = document.getElementById('btn-health-check');
const btnViewSched   = document.getElementById('btn-view-sched');

btnLogFeeding?.addEventListener('click', () => {
  const d = todayStr(); window.location.href = `caretaker-manage-feeding-schedule.html?action=log&date=${d}#log`;
});
btnHealthCheck?.addEventListener('click', () => {
  window.location.href = 'caretaker-manage-pig-records.html#health';
});
btnViewSched?.addEventListener('click', () => {
  const d = todayStr(); window.location.href = `caretaker-manage-feeding-schedule.html?date=${d}#today`;
});

// === Logout (clears any stored tokens and redirect to login) ===
(() => {
  const logoutEl = document.getElementById("logout");
  if (!logoutEl) return;

  logoutEl.addEventListener("click", (e) => {
    e.preventDefault();
    try {
      // clear every key we‚Äôve ever used
      ["auth_token", "token", "access_token"].forEach(k => {
        localStorage.removeItem(k);
        sessionStorage.removeItem(k);
      });
    } catch {}

    // redirect to your login page
    window.location.href = "/Zhomepage/login.html";
  });
})();


  // FE-only schedules live in localStorage (as per your project notes)
  function getLocalSchedules() {
    try {
      return JSON.parse(localStorage.getItem("feed_schedules") || "[]");
    } catch { return []; }
  }

  async function jget(path){ 
    const res = await fetch(path.startsWith("http") ? path : `${API_BASE}${path}`, { headers: headers() });
    if(!res.ok){ throw new Error(await res.text().catch(()=>res.statusText)); }
    return res.json();
  }
  async function jpost(path, body){ 
    const res = await fetch(`${API_BASE}${path}`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
    if(!res.ok){ throw new Error(await res.text().catch(()=>res.statusText)); }
    return res.json();
  }

  const withinNextHour = (when) => {
    const t = new Date(when);
    const now = new Date();
    const diff = (t - now)/60000; // minutes
    return diff >= -5 && diff <= 60; // small early tolerance
  };
  const isPast = (when) => new Date(when) < new Date();

  /* =======================
     DOM refs
  ======================= */
  const elKpiDue = document.getElementById("kpi-due");
  const elKpiDone = document.getElementById("kpi-done");
  const elKpiOverdue = document.getElementById("kpi-overdue");
  const elKpiSows = document.getElementById("kpi-sows");
  const elTimeline = document.getElementById("timeline");
  const elEmptyTimeline = document.getElementById("emptyTimeline");
  const elQueue = document.getElementById("queueCards");
  const elEmptyQueue = document.getElementById("emptyQueue");
  const elSowPregnant = document.getElementById("stat-pregnant");
  const elSowDue = document.getElementById("stat-due");
  const elSowOverdue = document.getElementById("stat-overdue");
  const elSowNursing = document.getElementById("stat-nursing");
  const elAlerts = document.getElementById("alerts");
  const elEmptyAlerts = document.getElementById("emptyAlerts");
  const elActivity = document.getElementById("activity");
  const elEmptyActivity = document.getElementById("emptyActivity");

  const tabBtns = Array.from(document.querySelectorAll('.ct-tabs .tab'));
  let queueTab = "due"; // 'due' | 'today'

  /* =======================
     Loaders
  ======================= */

  // Feeding logs for today
  async function loadTodayLogs(){
    // If you later add a query param on backend, e.g. /feeding-logs?date=YYYY-MM-DD, switch here.
    const rows = await jget("/feeding-logs");
    const d = todayStr();
    return (Array.isArray(rows) ? rows : []).filter(r => (r.feeding_time||"").startsWith(d));
  }

  // Build ‚Äúplanned‚Äù items from FE-only schedules (localStorage) limited to today
  function loadPlannedFromSchedules(){
    const d = todayStr();
    return getLocalSchedules()
      .filter(s => (s.date||"").startsWith(d))
      .map(s => ({
        litter_id: s.litter_id,
        pen: s.pen || "-",
        feed_type: s.feed_type || s.feed || "-",
        quantity_kg: s.quantity_kg || s.qty || "-",
        time: s.time || s.feeding_time || `${d}T08:00:00`,
        planned: true
      }));
  }

  // KPIs
  async function renderKpis(){
    const planned = loadPlannedFromSchedules();
    const logs = await loadTodayLogs();

    // match completed-by-litter+nearest-time (simple approx)
    const completed = logs.length;

    const dueNow = planned.filter(p => !logs.find(l => String(l.litter_id)===String(p.litter_id)) && withinNextHour(p.time)).length;
    const overdue = planned.filter(p => !logs.find(l => String(l.litter_id)===String(p.litter_id)) && isPast(p.time) && !withinNextHour(p.time)).length;

    elKpiDue.textContent = dueNow;
    elKpiDone.textContent = completed;
    elKpiOverdue.textContent = overdue;

    // Sows count
    const sows = await jget("/api/sows").catch(()=>[]);
    elKpiSows.textContent = Array.isArray(sows) ? sows.length : 0;
  }

  // Timeline
  async function renderTimeline(){
    const planned = loadPlannedFromSchedules()
      .sort((a,b)=> new Date(a.time)-new Date(b.time));

    elTimeline.innerHTML = "";
    if(!planned.length){ elEmptyTimeline.hidden = false; return; }
    elEmptyTimeline.hidden = true;

    planned.forEach(p=>{
      const status = isPast(p.time) ? "Due" : "Upcoming";
      const pillCls = isPast(p.time) ? "pill info" : "pill";
      const timeText = new Date(p.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      elTimeline.insertAdjacentHTML("beforeend", `
        <div class="tl-item">
          <div class="tl-time">${timeText}</div>
          <div class="tl-body">
            <div><strong>Litter #${p.litter_id}</strong> ‚Ä¢ ${p.feed_type} ${p.quantity_kg ? `‚Ä¢ ${p.quantity_kg} kg` : ""}</div>
            <div class="tl-meta">
              <span class="${pillCls}">${status}</span>
              <span class="pill">Pen ${p.pen||"-"}</span>
            </div>
          </div>
        </div>
      `);
    });
  }

  // Queue
  async function renderQueue(){
    const planned = loadPlannedFromSchedules();
    const logs = await loadTodayLogs();

    const items = planned.map(p => {
      const done = logs.find(l => String(l.litter_id)===String(p.litter_id));
      const status = done ? "Done" : (isPast(p.time) ? "Overdue" : (withinNextHour(p.time) ? "Due Now" : "Upcoming"));
      const cls = done ? "success" : (status==="Overdue" ? "warn" : (status==="Due Now" ? "info" : ""));
      return {...p, status, cls, doneAt: done?.feeding_time || null};
    });

    const filtered = (queueTab==="due")
      ? items.filter(i => i.status==="Due Now")
      : items;

    elQueue.innerHTML = "";
    if(!filtered.length){ elEmptyQueue.hidden = false; return; }
    elEmptyQueue.hidden = true;

    filtered.forEach(i=>{
      const timeText = new Date(i.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      elQueue.insertAdjacentHTML("beforeend", `
        <div class="q-card ${i.cls}">
          <div class="q-head">
            <div class="q-title">Litter #${i.litter_id} ‚Ä¢ Pen ${i.pen||"-"}</div>
            <span class="pill ${i.cls==='success'?'success':(i.cls==='warn'?'warn':(i.cls==='info'?'info':''))}">${i.status}</span>
          </div>
          <div>${i.feed_type} ${i.quantity_kg ? `‚Ä¢ ${i.quantity_kg} kg` : ""}</div>
          <div class="q-meta">
            <span class="pill"><i class="fa-regular fa-clock"></i> ${timeText}</span>
            ${i.doneAt ? `<span class="pill success"><i class="fa-solid fa-check"></i> ${new Date(i.doneAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>` : ""}
          </div>
          <div class="q-actions">
            <button class="q-btn primary" ${i.status==='Done'?'disabled':''} data-done="${i.litter_id}">Mark Done</button>
            <button class="q-btn" ${i.status==='Done'?'disabled':''} data-snooze="${i.litter_id}">Snooze 30m</button>
          </div>
        </div>
      `);
    });

    // Wire actions
    elQueue.querySelectorAll("[data-done]").forEach(btn=>{
      btn.onclick = async () => {
        const litterId = Number(btn.dataset.done);
        try{
          // POST /api/feeding-logs
          await jpost("/feeding-logs", {
            litter_id: litterId,
            caretaker_id: null,                    // backend infers from token if available
            feed_type: "scheduled",                // lightweight default
            quantity_kg: null,
            feeding_time: toNaive(new Date())      // YYYY-MM-DDTHH:mm:ss (naive)
          });
        }catch(e){ console.warn(e); }
        // refresh
        await renderKpis(); await renderQueue(); await renderActivity();
      };
    });
    elQueue.querySelectorAll("[data-snooze]").forEach(btn=>{
      btn.onclick = () => {
        const litterId = Number(btn.dataset.snooze);
        // FE-only: adjust local schedule by +30m
        const list = getLocalSchedules();
        const d = list.find(s => String(s.litter_id)===String(litterId) && (s.date||"").startsWith(todayStr()));
        if(d){
          const base = new Date(d.time || `${todayStr()}T08:00:00`);
          base.setMinutes(base.getMinutes()+30);
          d.time = base.toISOString();
          localStorage.setItem("feed_schedules", JSON.stringify(list));
          renderTimeline(); renderQueue();
        }
      };
    });
  }

  // Sow status + alerts
  async function renderSows(){
    const rows = await jget("/api/sows").catch(()=>[]);
    const list = Array.isArray(rows) ? rows : [];

    const pregnant = list.filter(s => s.status==='pregnant');
    const nursing = list.filter(s => s.status==='nursing');

    const dueThisWeek = pregnant.filter(s => {
      const eb = s.expected_birth ? new Date(s.expected_birth) : null;
      if(!eb) return false;
      const now = new Date();
      const diff = (eb - now)/86400000;
      return diff >= 0 && diff <= 7;
    });

    const overdue = list.filter(s => s.is_overdue === true || (s.status==='pregnant' && s.expected_birth && new Date(s.expected_birth) < new Date()));

    elSowPregnant.textContent = pregnant.length;
    elSowDue.textContent = dueThisWeek.length;
    elSowOverdue.textContent = overdue.length;
    elSowNursing.textContent = nursing.length;

    // Alerts
    elAlerts.innerHTML = "";
    if(!overdue.length){ elEmptyAlerts.hidden = false; } else {
      elEmptyAlerts.hidden = true;
      overdue.slice(0,4).forEach(s=>{
        elAlerts.insertAdjacentHTML("beforeend", `
          <div class="ct-alert">
            <strong>Sow ${s.sow_identifier || s.id}</strong> expected birth ${s.expected_birth ? new Date(s.expected_birth).toLocaleDateString() : '(unknown)'} ‚Äî <em>Overdue</em>
          </div>
        `);
      });
    }
  }

  // Recent activity (from feeding logs)
  async function renderActivity(){
    const logs = await loadTodayLogs();
    elActivity.innerHTML = "";
    if(!logs.length){ elEmptyActivity.hidden = false; return; }
    elEmptyActivity.hidden = true;

    logs.sort((a,b)=> new Date(b.feeding_time) - new Date(a.feeding_time))
        .slice(0,10)
        .forEach(l=>{
          const t = new Date(l.feeding_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          elActivity.insertAdjacentHTML("beforeend", `
            <div class="act"><div class="act-time">${t}</div>
              <div>Fed Litter #${l.litter_id} ${l.feed_type ? `(${l.feed_type}` : ""}${l.quantity_kg ? ` ‚Ä¢ ${l.quantity_kg} kg` : ""}${l.feed_type ? `)` : ""}</div>
            </div>
          `);
        });
  }

  // Shift label (placeholder)
  document.getElementById("shiftLabel").textContent = "Shift: 6:00 AM ‚Äì 6:00 PM";

  // Tab switching
  tabBtns.forEach(b=>{
    b.onclick = () => {
      tabBtns.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      queueTab = b.dataset.qtab;
      renderQueue();
    };
  });

  // Utils
  function toNaive(dt){
    // -> "YYYY-MM-DDTHH:mm:ss" (naive)
    const pad=(n)=> String(n).padStart(2,"0");
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
  }

  /* =======================
     Boot
  ======================= */
  (async function boot(){
    try {
      await Promise.all([renderKpis(), renderTimeline(), renderQueue(), renderSows(), renderActivity()]);
    } catch (e) {
      console.warn("Dashboard load error:", e);
    }
    // light auto-refresh
    setInterval(()=>{ renderKpis(); renderQueue(); renderActivity(); }, 60000);
  })();
</script>

</body>
</html>
