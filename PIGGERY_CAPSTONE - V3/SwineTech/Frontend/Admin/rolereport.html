<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Reports</title>

  <!-- Styles -->
  <link rel="stylesheet" href="/Admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    .page-desc { margin: 6px 0 18px; color:#555; }
    .report-actions { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px; }
    .btn-add { background:#29B6F6; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .btn-add:disabled { opacity:.6; cursor:not-allowed; }
    .btn-view { background:#43A047; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .empty { padding:18px; background:#fff; border:1px solid #eee; border-radius:8px; color:#666; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; font-size:.85rem; }
    .muted { color:#777; font-size:.9rem; }
    .modal pre { white-space:pre-wrap; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-admin.html"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</a>
      <a href="admin-manage-user-accounts.html"><i class="fa-solid fa-users"></i> Manage User Accounts</a>
      <a href="admin-manage-pig-records.html"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="admin-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedule</a>
      <a href="admin-manage-supplies.html"><i class="fa-solid fa-boxes-stacked"></i> Manage Supplies</a>
      <a href="admin-manage-sales-expenses-bookings.html"><i class="fa-solid fa-money-bill-trend-up"></i> Manage Sales, Expenses, & Bookings</a>
      <a href="admin-manage-client-feedback-admin.html"><i class="fa-solid fa-comment-dots"></i> Manage Client Feedback</a>
      <a href="inquiries.html"><i class="fa-solid fa-envelope"></i> Inquiries</a>
      <a href="admin-generate-reports.html" class="active"><i class="fa-solid fa-file-lines"></i> Reports</a>
      <a href="#" id="logout" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard">
    <h1>Reports</h1>
    <p class="page-desc">Generate and view reports. Non-admins can only see the reports they generated.</p>

    <!-- Role-based actions -->
    <div id="report-actions" class="report-actions"></div>

    <!-- Report History -->
    <div class="report-results">
      <h2 style="margin:14px 0"><i class="fa-solid fa-clock-rotate-left"></i> Generated Report History</h2>

      <table class="admin-table" id="reportsTable" style="display:none">
        <thead>
          <tr>
            <th>Report ID</th>
            <th>Type</th>
            <th>Generated By (user_id)</th>
            <th>Date Generated</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="reportsTbody"></tbody>
      </table>

      <div id="reportsEmpty" class="empty" style="display:none">
        No reports yet.
      </div>
    </div>
  </main>

  <!-- View Modal -->
  <div id="reportModal" class="modal" style="display:none">
    <div class="modal-content">
      <span class="close" id="modalClose" style="cursor:pointer">&times;</span>
      <h2>Report Details</h2>
      <p><strong>Report Type:</strong> <span id="modalType" class="tag"></span></p>
      <p class="muted"><strong>Generated At:</strong> <span id="modalWhen"></span> ‚Ä¢ <strong>By:</strong> <span id="modalBy"></span></p>

      <div class="report-data" style="margin-top:10px">
        <h3>Data</h3>
        <pre id="modalData">Loading‚Ä¶</pre>
      </div>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
    // If your wrapper lives elsewhere, adjust this path:
    import { authApi, reportsApi, clearToken } from "/static/_shared/js/api.js";

    const $ = (sel) => document.querySelector(sel);
    const reportActions = $("#report-actions");
    const reportsTable = $("#reportsTable");
    const reportsTbody = $("#reportsTbody");
    const reportsEmpty = $("#reportsEmpty");

    const modal = $("#reportModal");
    const modalClose = $("#modalClose");
    const modalType = $("#modalType");
    const modalWhen = $("#modalWhen");
    const modalBy = $("#modalBy");
    const modalData = $("#modalData");

    let currentUser = null;

    const TYPE_LABEL = {
      sales: "Sales",
      inventory: "Inventory",
      mortality: "Mortality",
      feed_consumption: "Feed Consumption",
    };

    // --- Bootstrap ---
    init().catch(err => toast(err?.message || "Failed to load."));

    async function init() {
      // 1) who am I
      currentUser = await authApi.me();

      // 2) buttons by role
      renderRoleButtons(currentUser.role);

      // 3) load history
      await loadReports();
    }

    function renderRoleButtons(role) {
      const R = String(role || "").toUpperCase();
      const can = {
        sales: R === "ADMIN" || R === "SALES",
        inventory: R === "ADMIN" || R === "PROCUREMENT",
        mortality: R === "ADMIN",
        feed_consumption: R === "ADMIN",
      };

      const btn = (type, label, emoji) =>
        `<button class="btn-add" data-type="${type}">${emoji} Generate ${label}</button>`;

      let html = "";
      if (can.sales)           html += btn("sales", "Sales Report", "üí∞");
      if (can.inventory)       html += btn("inventory", "Inventory Report", "üì¶");
      if (can.mortality)       html += btn("mortality", "Mortality Report", "‚ö†Ô∏è");
      if (can.feed_consumption)html += btn("feed_consumption", "Feed Consumption Report", "üçΩÔ∏è");

      reportActions.innerHTML = html || `<span class="muted">You do not have permission to generate reports.</span>`;
      reportActions.querySelectorAll("button[data-type]").forEach(b =>
        b.addEventListener("click", () => handleGenerate(b.dataset.type, b))
      );
    }

    async function loadReports() {
      // Backend: GET /reports (admins see all; non-admins should only get their own)
      let rows = [];
      try {
        rows = await reportsApi.list(); // filters not needed here
      } catch (e) {
        toast(e.message || "Failed to load reports");
        return;
      }

      if (!rows || rows.length === 0) {
        reportsTable.style.display = "none";
        reportsEmpty.style.display = "block";
        return;
      }

      reportsTbody.innerHTML = rows.map(r => trReport(r)).join("");
      reportsTable.style.display = "";
      reportsEmpty.style.display = "none";

      // Bind view buttons
      reportsTbody.querySelectorAll("[data-view]").forEach(btn => {
        btn.addEventListener("click", () => openReport(btn.dataset.id));
      });
    }

    function trReport(r) {
      const id = r.id;
      const type = TYPE_LABEL[r.report_type] || r.report_type;
      const by = r.generated_by ?? "‚Äî";
      const when = fmtDate(r.generated_at);
      return `
        <tr>
          <td>${id}</td>
          <td><span class="tag">${type}</span></td>
          <td>${by}</td>
          <td>${when}</td>
          <td><button class="btn-view" data-view data-id="${id}"><i class="fa-solid fa-eye"></i> View</button></td>
        </tr>
      `;
    }

    async function handleGenerate(type, btn) {
      btn.disabled = true;

      const today = new Date();
      const dTo = today.toISOString().slice(0,10);
      const dFrom = new Date(today.getTime() - 30*24*3600*1000).toISOString().slice(0,10);

      const payload = {
        report_type: type,        // "sales" | "inventory" | "mortality" | "feed_consumption"
        filters: {
          date_from: dFrom,
          date_to: dTo,
          // low_stock_threshold only used by inventory on the backend; include a default
          low_stock_threshold: type === "inventory" ? 10 : undefined,
        },
        snapshot: true,           // save to DB (per your backend)
      };

      try {
        const created = await reportsApi.generate(payload);
        toast(`Generated ${TYPE_LABEL[type] || type} report (id ${created.id}).`);
        await loadReports();
      } catch (e) {
        toast(e.message || "Failed to generate report");
      } finally {
        btn.disabled = false;
      }
    }

    async function openReport(id) {
      try {
        const r = await reportsApi.get(id);
        modalType.textContent = TYPE_LABEL[r.report_type] || r.report_type;
        modalWhen.textContent = fmtDate(r.generated_at);
        modalBy.textContent = r.generated_by ?? "‚Äî";
        try {
          // data can be object/string; show pretty JSON when possible
          modalData.textContent = typeof r.data === "string" ? r.data : JSON.stringify(r.data, null, 2);
        } catch {
          modalData.textContent = String(r.data ?? "");
        }
        modal.style.display = "block";
      } catch (e) {
        toast(e.message || "Failed to load report");
      }
    }

    modalClose.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });

    // --- helpers ---
    function fmtDate(s) {
      if (!s) return "‚Äî";
      try {
        const d = new Date(s);
        return d.toLocaleString();
      } catch { return s; }
    }
    function toast(msg) {
      console.log("[reports]", msg);
      // You can replace this with a nicer toast if you have one in admin.css:
      alert(msg);
    }

    // Optional: Logout
    $("#logout")?.addEventListener("click", (e) => {
      e.preventDefault();
      clearToken();
      window.location.href = "/static/login.html";
    });
  </script>
</body>
</html>
