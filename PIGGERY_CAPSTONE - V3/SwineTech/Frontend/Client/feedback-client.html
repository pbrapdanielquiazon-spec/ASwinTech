<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwineTech | Client Feedback</title>
  <link rel="stylesheet" href="/Client/client.css">
  <link rel="stylesheet" href="/Admin/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --bg:#F7F8FA; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --stroke:#EEF2F6; --green:#2E7D32; --green-2:#1B5E20; --accent:#0ea5e9;
      --shadow:0 10px 28px rgba(16,24,40,.10);
      --shadow-sm:0 6px 16px rgba(16,24,40,.08);
      --radius:16px;
    }
    main.dashboard{ background:var(--bg); }

    /* Header centered */
    .page-head{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:16px; margin:6px 0 18px;
    }
    .head-center{ text-align:center; }
    .h-title{ margin:0; font-size:28px; font-weight:800; color:var(--ink); letter-spacing:.2px; }
    .h-sub{ margin:6px 0 0; color:var(--muted); }
    .cta-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .btn-primary{
      background:var(--green); color:#fff; border:none; border-radius:12px; padding:10px 14px;
      font-weight:700; cursor:pointer; box-shadow:var(--shadow-sm); transition:transform .08s ease, background .15s ease;
    }
    .btn-primary:hover{ background:var(--green-2); transform:translateY(-1px); }
    .btn-primary:active{ transform:translateY(0); }

    /* Stats */
    .stats{
      display:grid; grid-template-columns:repeat(3, minmax(180px,1fr)); gap:12px; margin:8px 0 16px;
    }
    .stat{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow-sm); padding:14px;
    }
    .stat-label{ color:#334155; font-weight:700; margin-bottom:4px; }
    .stat-value{ font-size:22px; font-weight:800; color:var(--ink); }

    /* Card list (replaces table) */
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px;
    }
    .fb-list{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:12px;
      margin-top:6px;
    }
    .fb-card{
      border:1px solid var(--stroke);
      border-radius:14px;
      background:#fff;
      padding:12px 12px 10px;
      box-shadow:var(--shadow-sm);
      animation:fadeIn .18s ease;
    }
    @keyframes fadeIn{ from{opacity:.0; transform:translateY(4px)} to{opacity:1; transform:none} }

    .fb-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-weight:800; font-size:.8rem;
      background:#f1f5f9; color:#0f172a; border:1px solid #e5e7eb;
    }
    .fb-date{ font-size:.85rem; color:var(--muted); white-space:nowrap; }
    .fb-comment{
      color:#111827; line-height:1.4; font-size:.98rem;
      display:-webkit-box; -webkit-line-clamp:5; -webkit-box-orient:vertical; overflow:hidden;
      white-space:pre-wrap;
    }

    .empty{
      text-align:center; color:var(--muted); padding:20px 8px; font-size:15px;
    }

    /* Modal */
    .modal{ display:none; position:fixed; inset:0; background:rgba(2,6,23,.45); z-index:999; }
    .modal .box{
      background:#fff; width:580px; max-width:95%; margin:5% auto; border-radius:18px; padding:18px 18px 16px;
      border:1px solid var(--stroke); box-shadow:0 24px 60px rgba(2,6,23,.25);
    }
    .modal .close{ position:absolute; right:18px; top:12px; font-size:20px; color:#6b7280; cursor:pointer; }
    .modal .close:hover{ color:#ef4444; }
    .form-group{ margin-bottom:12px; }
    .form-group label{ display:block; font-weight:700; margin-bottom:6px; color:#111827; }
    .form-group textarea{
      width:100%; min-height:130px; border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; resize:vertical;
      outline:none; transition:border .15s ease, box-shadow .15s ease;
    }
    .form-group textarea:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.15); }
    .btn-auth{ width:100%; border:none; background:var(--green); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; }
    .btn-auth:hover{ background:var(--green-2); }
    .row-foot{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; }
    .hint{ color:var(--muted); font-size:.9rem; }

    @media (max-width:900px){
      .page-head{ grid-template-columns:1fr; }
      .cta-row{ justify-content:center; }
      .stats{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Sidebar (unchanged) -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-client.html"><i class="fa-solid fa-house"></i> Dashboard</a>
      <a href="availablepig-bookings-inquiry-receipts-client.html#pigs"><i class="fa-solid fa-piggy-bank"></i> Available Pigs</a>
      <a href="availablepig-bookings-inquiry-receipts-client.html#bookings"><i class="fa-solid fa-calendar-check"></i> Bookings</a>
      <a href="availablepig-bookings-inquiry-receipts-client.html#inquiry"><i class="fa-solid fa-envelope"></i> Inquiries</a>
      <a href="feedback-client.html" class="active"><i class="fa-solid fa-comment-dots"></i> Feedback</a>
      <a href="availablepig-bookings-inquiry-receipts-client.html#receipts"><i class="fa-solid fa-receipt"></i> Receipts</a>
      <a href="client-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="#" id="logoutLink" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="dashboard">
    <!-- Centered header -->
    <div class="page-head">
      <div class="head-center">
        <h1 class="h-title">My Feedback</h1>
        <p class="h-sub">Tell us what worked well and what needs love. ‚ú®</p>
      </div>
      <div class="cta-row">
        <button class="btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> Add Feedback</button>
      </div>
    </div>

    <!-- Stats -->
    <section class="stats">
      <div class="stat">
        <div class="stat-label">Total Feedback</div>
        <div class="stat-value" id="statCount">‚Äî</div>
      </div>
      <div class="stat">
        <div class="stat-label">Last Submitted</div>
        <div class="stat-value" id="statLast">‚Äî</div>
      </div>
      <div class="stat">
        <div class="stat-label">This Month</div>
        <div class="stat-value" id="statMTD">‚Äî</div>
      </div>
    </section>

    <!-- Card list -->
    <section class="card">
      <div id="feedbackList" class="fb-list">
        <!-- cards injected here -->
      </div>
      <div id="feedbackEmpty" class="empty" style="display:none;">You haven‚Äôt submitted any feedback yet.</div>
    </section>
  </main>

  <!-- Add Feedback Modal -->
  <div id="feedbackModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-labelledby="fbTitle">
      <span class="close" onclick="closeModal()" aria-label="Close">&times;</span>
      <h2 id="fbTitle" style="text-align:center; margin:2px 0 12px;">Add Feedback</h2>
      <form id="feedbackForm" onsubmit="return submitFeedback(event)">
        <div class="form-group">
          <label for="comment">Your Feedback</label>
          <textarea id="comment" maxlength="1000" placeholder="Share your experience, suggestions, or issues‚Ä¶ (max 1000 chars)" required></textarea>
          <div class="row-foot">
            <span class="hint" id="charHint">0 / 1000</span>
            <span id="fbMsg" class="hint"></span>
          </div>
        </div>
        <button class="btn-auth btn-primary" type="submit"><i class="fa-solid fa-paper-plane"></i> Submit</button>
      </form>
    </div>
  </div>

  <script>
    /* Config */
    const API_BASE = "http://localhost:8000/api";

    /* Auth helpers */
    function getToken() {
      return localStorage.getItem("auth_token")
          || localStorage.getItem("token")
          || localStorage.getItem("access_token");
    }
    function clearToken() {
      ["auth_token","token","access_token"].forEach(k=>{
        localStorage.removeItem(k); sessionStorage.removeItem(k);
      });
    }
    async function authFetch(url, opts = {}) {
      const token = getToken();
      const headers = Object.assign(
        { "Content-Type": "application/json", Accept:"application/json" },
        token ? { Authorization: `Bearer ${token}` } : {}
      );
      const res = await fetch(url, { ...opts, headers, credentials:"include" });
      const txt = await res.text();
      let data; try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
      if (!res.ok) {
        const err = new Error(data?.detail || res.statusText || "Request failed");
        err.status = res.status; err.body = data; throw err;
      }
      return data;
    }

    /* Data */
    let feedbackRows = [];

    function formatDatePH(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        const parts = d.toLocaleString('en-PH', {
          timeZone: 'Asia/Manila',
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', hour12: false
        });
        const [mmddyyyy, time] = parts.split(',').map(s => s.trim());
        const [m, day, y] = mmddyyyy.split('/');
        return `${y}-${m.padStart(2,'0')}-${day.padStart(2,'0')} ${time}`;
      } catch { return iso; }
    }

    function isMTD(iso){
      if (!iso) return false;
      const d = new Date(iso);
      const now = new Date();
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    }

    async function loadMyFeedback() {
      try {
        const rows = await authFetch(`${API_BASE}/feedback/mine`);
        feedbackRows = Array.isArray(rows) ? rows.map(r => ({
          id: r.id ?? r.feedback_id ?? "-",
          comment: r.comment ?? r.message ?? "",
          submitted_at: r.submitted_at ?? r.created_at ?? ""
        })) : [];
      } catch (e) {
        console.error("loadMyFeedback failed:", e);
        feedbackRows = [];
      }
      renderFeedbackCards();
      updateStats();
    }

    /* NEW: render as cards (less Excel-like) */
    function renderFeedbackCards(){
      const wrap = document.getElementById("feedbackList");
      const empty = document.getElementById("feedbackEmpty");
      wrap.innerHTML = "";

      if (!feedbackRows.length){
        empty.style.display = "";
        return;
      }
      empty.style.display = "none";

      feedbackRows
        .slice()
        .sort((a,b)=> new Date(b.submitted_at) - new Date(a.submitted_at))
        .forEach(row=>{
          const card = document.createElement("div");
          card.className = "fb-card";
          card.innerHTML = `
            <div class="fb-head">
              <span class="chip"><i class="fa-solid fa-message"></i> #${escapeHtml(row.id)}</span>
              <span class="fb-date">${escapeHtml(formatDatePH(row.submitted_at))}</span>
            </div>
            <div class="fb-comment">${escapeHtml(row.comment || "(no comment)")}</div>
          `;
          wrap.appendChild(card);
        });
    }

    function updateStats(){
      const count = feedbackRows.length;
      const last = feedbackRows
        .slice()
        .sort((a,b)=> new Date(b.submitted_at) - new Date(a.submitted_at))[0]?.submitted_at || "";
      const mtd  = feedbackRows.filter(r => isMTD(r.submitted_at)).length;

      document.getElementById("statCount").textContent = count || 0;
      document.getElementById("statLast").textContent  = last ? formatDatePH(last) : "‚Äî";
      document.getElementById("statMTD").textContent   = mtd || 0;
    }

    /* Modal + submit */
    function openModal() {
      document.getElementById("comment").value = "";
      document.getElementById("charHint").textContent = "0 / 1000";
      setFbMsg("", false);
      document.getElementById("feedbackModal").style.display = "block";
    }
    function closeModal() {
      document.getElementById("feedbackModal").style.display = "none";
    }
    async function submitFeedback(e) {
      e.preventDefault();
      const comment = document.getElementById("comment").value.trim();
      if (!comment) { setFbMsg("Please enter your feedback.", true); return false; }
      try {
        await authFetch(`${API_BASE}/feedback`, {
          method: "POST",
          body: JSON.stringify({ comment })
        });
        setFbMsg("Feedback submitted. Thank you!", false);
        await loadMyFeedback();
        setTimeout(closeModal, 600);
      } catch (err) {
        console.error("submitFeedback failed:", err);
        setFbMsg("Failed to submit feedback. Please try again.", true);
      }
      return true;
    }
    function setFbMsg(text, isErr) {
      const p = document.getElementById("fbMsg");
      p.textContent = text;
      p.style.color = isErr ? "crimson" : "var(--green-2)";
    }

    /* Misc UI */
    document.getElementById("logoutLink")?.addEventListener("click", (e) => {
      e.preventDefault(); clearToken(); window.location.href = "/Zhomepage/login.html";
    });
    window.addEventListener("click", (e) => {
      const m = document.getElementById("feedbackModal");
      if (e.target === m) closeModal();
    });
    function escapeHtml(s) {
      return (""+s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    document.addEventListener("input", (e)=>{
      if (e.target && e.target.id === "comment") {
        const v = e.target.value || "";
        document.getElementById("charHint").textContent = `${v.length} / 1000`;
      }
    });

    /* Init */
    document.addEventListener("DOMContentLoaded", loadMyFeedback);
  </script>
</body>
</html>
