<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Manage Pig Records</title>
  <link rel="stylesheet" href="/Admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* Tabs */
    .tabs { margin: 20px 0; }
    .tab-btn { background:#f0f0f0; border:none; padding:10px 20px; cursor:pointer; margin-right:5px; border-radius:5px; }
    .tab-btn.active { background:#43A047; color:#fff; }
    .record-view { display:none; }
    .record-view.active { display:block; }

    /* Modal */
    .modal { display:none; position:fixed; z-index:10; inset:0; background:rgba(0,0,0,.5); }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:600px; max-width:95%; }
    .modal h2 { margin-bottom:15px; }
    .close { float:right; font-size:22px; cursor:pointer; }

    /* Forms & Buttons */
    .form-group { margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:5px; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .btn-auth { background:#43A047; color:#fff; border:none; padding:10px; width:100%; border-radius:5px; cursor:pointer; }
    .btn-auth:hover { background:#2e7d32; }
    .btn-add, .btn-edit, .btn-archive, .btn-restore { padding:6px 12px; margin:2px; border:none; border-radius:5px; cursor:pointer; }
    .btn-add { background:#29B6F6; color:#fff; }
    .btn-edit { background:#FFA726; color:#fff; }
    .btn-archive { background:#EF5350; color:#fff; }
    .btn-restore { background:#29B6F6; color:#fff; }

    .filter-box { margin:10px 0; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:10px; }
    .admin-table th, .admin-table td { border:1px solid #ccc; padding:8px; text-align:center; }
    .admin-table th { background:#f9f9f9; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-admin.html"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</a>
      <a href="admin-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="admin-manage-user-accounts.html"><i class="fa-solid fa-users"></i> Manage User Accounts</a>
      <a href="admin-manage-pig-records.html" class="active"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="admin-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedule</a>
      <a href="admin-manage-supplies.html"><i class="fa-solid fa-boxes-stacked"></i> Manage Supplies</a>
      <a href="admin-manage-sales-expenses-bookings.html"><i class="fa-solid fa-money-bill-trend-up"></i> Manage Sales, Expenses & Bookings</a>
      <a href="admin-manage-client-feedback-admin.html"><i class="fa-solid fa-comment-dots"></i> Manage Client Feedback</a>
      <a href="admin-generate-reports.html"><i class="fa-solid fa-file-lines"></i> Generate Reports</a>
      <a href="#" id="logoutLink" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="dashboard">
    <h1>Manage Pig Records</h1>

    <div class="tabs">
      <button class="tab-btn active" onclick="showView('litter')">üêñ Litter Records</button>
      <button class="tab-btn" onclick="showView('individual')">üê∑ Individual Pigs</button>
      <button class="tab-btn" onclick="showView('health')">‚ù§Ô∏è Health Records</button>
      <button class="tab-btn" onclick="showView('breeding')">üß¨ Breeding Records</button>
      <button class="tab-btn" onclick="showView('available')">üêΩ Available Pigs</button>
      <button class="tab-btn" onclick="showView('archived')">üìÇ Archived Records</button>
    </div>

    <!-- LITTERS -->
    <section id="litter" class="record-view active">
      <h2>Litter Records</h2>
      <button type="button" class="btn-add" onclick="openModal('addLitterModal')">+ Add New Litter</button>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Litter ID</th><th>Sow Identifier</th><th>Birth Date</th><th>Litter Size</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="litterTable"></tbody>
      </table>
    </section>

    <!-- PIGS -->
    <section id="individual" class="record-view">
      <h2>Individual Pig Records</h2>
      <button type="button" class="btn-add" onclick="openModal('addPigModal')">+ Add New Pig</button>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Pigs ID</th><th>Litter ID</th><th>Sow Identifier</th><th>Birth Date</th><th>Status</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="pigTable"></tbody>
      </table>
    </section>

    <!-- HEALTH -->
    <section id="health" class="record-view">
      <h2>Pig Health Records</h2>
      <button type="button" class="btn-add" onclick="openModal('addHealthModal')">+ Add Health Record</button>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Health Record ID</th><th>Pig ID</th><th>Diagnosis</th><th>Treatment</th><th>Recorded At</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="healthTable"></tbody>
      </table>
    </section>

    <!-- BREEDING (placeholder until endpoints exist) -->
    <section id="breeding" class="record-view">
      <h2>Breeding Records</h2>
      <button type="button" class="btn-add" onclick="openModal('addBreedingModal')">+ Add Breeding Record</button>
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Sow Identifier</th>
            <th>Status</th>
            <th>Mating Date</th>
            <th>Expected Birth</th>
            <th>Last Birth Date</th>
            <th>Caretaker ID</th>
            <th>Overdue?</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="breedingTable"></tbody>
      </table>

    </section>

    <!-- AVAILABLE PIGS -->
    <section id="available" class="record-view">
      <h2>Available Pigs</h2>

      <div class="filter-box">
        <label for="availableFilter">Filter:</label>
        <select id="availableFilter">
          <option value="available" selected>Available</option>
          <option value="reserved">Reserved</option>
          <option value="sold">Sold</option>
          <option value="all">All</option>
        </select>
        <button type="button" class="btn-add" style="margin-left:10px" onclick="openModal('addAvailableModal')">+ Add Available Pig</button>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th>Available Pigs ID</th>
            <th>Pigs ID</th>
            <th>Weight kg</th>
            <th>Sale Type</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="availableTable"></tbody>
      </table>
    </section>

    <!-- ARCHIVED UI (client-side display only) -->
    <section id="archived" class="record-view">
      <h2>Archived Records</h2>
      <div class="filter-box">
        <label>Show:</label>
        <select id="archiveFilter" onchange="filterArchived()">
          <option value="all">All</option>
          <option value="litter">Litter</option>
          <option value="pig">Pig</option>
          <option value="health">Health</option>
          <option value="breeding">Breeding</option>
        </select>
      </div>

      <div class="archived-section" data-type="litter">
        <h3>üêñ Archived Litter</h3>
        <table class="admin-table">
          <thead><tr><th>Litter ID</th><th>Sow Identifier</th><th>Birth Date</th><th>Size</th><th>Actions</th></tr></thead>
          <tbody id="archivedLitter"></tbody>
        </table>
      </div>

      <div class="archived-section" data-type="pig">
        <h3>üê∑ Archived Pigs</h3>
        <table class="admin-table">
          <thead><tr><th>Pigs ID</th><th>Litter ID</th><th>Sow Identifier</th><th>Birth Date</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="archivedPig"></tbody>
        </table>
      </div>

      <div class="archived-section" data-type="health">
        <h3>‚ù§Ô∏è Archived Health</h3>
        <table class="admin-table">
          <thead><tr><th>Health Record ID</th><th>Pig ID</th><th>Diagnosis</th><th>Treatment</th><th>Recorded At</th><th>Actions</th></tr></thead>
          <tbody id="archivedHealth"></tbody>
        </table>
      </div>

      <div class="archived-section" data-type="breeding">
        <h3>üß¨ Archived Breeding</h3>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Sow Identifier</th>
              <th>Status</th>
              <th>Mating Date</th>
              <th>Expected Birth</th>
              <th>Last Birth Date</th>
              <th>Caretaker ID</th>
              <th>Overdue?</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archivedBreeding"></tbody>
        </table>
      </div>


      <div class="archived-section" data-type="available">
        <h3>üêΩ Archived Available Pigs</h3>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Available Pigs ID</th>
              <th>Pigs ID</th>
              <th>Weight kg</th>
              <th>Sale Type</th>
              <th>Status</th>
              <th>Created At</th>
              <th>Updated At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archivedAvailable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <!-- Add/Edit Litter -->
  <div id="addLitterModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('addLitterModal')">&times;</span>
    <h2>Add Litter</h2>
    <form onsubmit="return addRecord(event,'litter')">
      <div class="form-group"><label>Sow Identifier</label><input type="text" id="litterSow" required></div>
      <div class="form-group"><label>Birth Date</label><input type="date" id="litterBirth" required></div>
      <div class="form-group"><label>Litter Size</label><input type="number" id="litterSize" min="0" required></div>
      <button type="submit" class="btn-auth">Save</button>
    </form>
  </div></div>

  <div id="editLitterModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('editLitterModal')">&times;</span>
    <h2>Edit Litter</h2>
    <form onsubmit="return updateRecord(event,'litter')">
      <div class="form-group"><label>Sow Identifier</label><input type="text" id="editLitterSow" required></div>
      <div class="form-group"><label>Birth Date</label><input type="date" id="editLitterBirth" required></div>
      <div class="form-group"><label>Litter Size</label><input type="number" id="editLitterSize" min="0" required></div>
      <button type="submit" class="btn-auth">Update</button>
    </form>
  </div></div>

  <!-- Add/Edit Pig -->
  <div id="addPigModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('addPigModal')">&times;</span>
    <h2>Add Pig</h2>
    <form onsubmit="return addRecord(event,'pig')">
      <div class="form-group"><label>Litter ID</label><input type="number" id="pigLitter" min="1" required></div>
      <div class="form-group"><label>Sow Identifier</label><input type="text" id="pigSow" required></div>
      <div class="form-group"><label>Birth Date</label><input type="date" id="pigBirth" required></div>
      <div class="form-group"><label>Status</label>
        <select id="pigStatus">
          <option value="healthy">Healthy</option>
          <option value="sick">Sick</option>
          <option value="sold">Sold</option>
          <option value="deceased">Deceased</option>
        </select>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="pigNotes"></textarea></div>
      <button type="submit" class="btn-auth">Save</button>
    </form>
  </div></div>

  <div id="editPigModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('editPigModal')">&times;</span>
    <h2>Edit Pig</h2>
    <form onsubmit="return updateRecord(event,'pig')">
      <div class="form-group"><label>Litter ID</label><input type="number" id="editPigLitter" min="1" required></div>
      <div class="form-group"><label>Sow Identifier</label><input type="text" id="editPigSow" required></div>
      <div class="form-group"><label>Birth Date</label><input type="date" id="editPigBirth" required></div>
      <div class="form-group"><label>Status</label>
        <select id="editPigStatus">
          <option value="healthy">Healthy</option>
          <option value="sick">Sick</option>
          <option value="sold">Sold</option>
          <option value="deceased">Deceased</option>
        </select>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="editPigNotes"></textarea></div>
      <button type="submit" class="btn-auth">Update</button>
    </form>
  </div></div>

<!-- ADD AVAILABLE PIG -->
<div id="addAvailableModal" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('addAvailableModal')">&times;</span>
  <h2>Add Available Pig</h2>
  <form id="addAvailableForm">
    <div class="form-group">
      <label>Pigs ID</label>
      <select id="avPigId" required></select>
    </div>
    <div class="form-group">
      <label>Weight (kg)</label>
      <input type="number" id="avWeight" min="0.01" step="0.01" required />
    </div>
    <div class="form-group">
      <label>Sale Type</label>
      <select id="avSaleType" required>
        <option value="market">market</option>
        <option value="lechon">lechon</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="avNotes"></textarea>
    </div>
    <button class="btn-auth" type="submit">Save</button>
  </form>
</div></div>

<!-- EDIT AVAILABLE PIG -->
<div id="editAvailableModal" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('editAvailableModal')">&times;</span>
  <h2>Edit Available Pig</h2>
  <form id="editAvailableForm">
    <div class="form-group">
      <label>Weight (kg)</label>
      <input type="number" id="editAvWeight" min="0.01" step="0.01" required />
    </div>
    <div class="form-group">
      <label>Sale Type</label>
      <select id="editAvSaleType" required>
        <option value="market">market</option>
        <option value="lechon">lechon</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="editAvNotes"></textarea>
    </div>
    <button class="btn-auth" type="submit">Update</button>
  </form>
</div></div>


  <!-- Add/Edit Health -->
  <div id="addHealthModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('addHealthModal')">&times;</span>
    <h2>Add Health</h2>
    <form onsubmit="return addRecord(event,'health')">
      <div class="form-group"><label>Pig ID</label><input type="number" id="healthPig" required></div>
      <div class="form-group"><label>Diagnosis</label><input type="text" id="healthDiagnosis" required></div>
      <div class="form-group"><label>Treatment</label><input type="text" id="healthTreatment"></div>
      <div class="form-group"><label>Recorded At</label><input type="date" id="healthDate"></div>
      <button type="submit" class="btn-auth">Save</button>
    </form>
  </div></div>

  <div id="editHealthModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('editHealthModal')">&times;</span>
    <h2>Edit Health</h2>
    <form onsubmit="return updateRecord(event,'health')">
      <div class="form-group"><label>Pig ID</label><input type="number" id="editHealthPig" required></div>
      <div class="form-group"><label>Diagnosis</label><input type="text" id="editHealthDiagnosis" required></div>
      <div class="form-group"><label>Treatment</label><input type="text" id="editHealthTreatment"></div>
      <div class="form-group"><label>Recorded At</label><input type="date" id="editHealthDate"></div>
      <button type="submit" class="btn-auth">Update</button>
    </form>
  </div></div>

  <!-- Add/Edit Breeding -->
  <!-- CREATE SOW -->
  <div id="addBreedingModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('addBreedingModal')">&times;</span>
    <h2>Create Sow</h2>
    <form id="createSowForm" onsubmit="return addRecord(event,'breeding')">
      <div class="form-group"><label>Sow Identifier</label>
        <input type="text" id="sowCreate_identifier" required />
      </div>
      <div class="form-group"><label>Status</label>
        <select id="sowCreate_status" required>
          <option value="nonpregnant">nonpregnant</option>
          <option value="pregnant">pregnant</option>
          <option value="miscarriage">miscarriage</option>
          <option value="gave_birth">gave_birth</option>
          <option value="nursing">nursing</option>
        </select>
      </div>
      <div class="form-group"><label>Mating Date (optional)</label>
        <input type="date" id="sowCreate_mating_date" />
      </div>
      <button type="submit" class="btn-auth">Save</button>
    </form>
  </div></div>


  <!-- EDIT SOW -->
  <div id="editBreedingModal" class="modal"><div class="modal-content">
    <span class="close" onclick="closeModal('editBreedingModal')">&times;</span>
    <h2>Edit Sow</h2>
    <form id="editSowForm">
      <div class="form-group"><label>Sow Identifier</label>
        <input type="text" id="sowEdit_identifier" required />
      </div>
      <div class="form-group"><label>Status</label>
        <select id="sowEdit_status" required>
          <option value="nonpregnant">nonpregnant</option>
          <option value="pregnant">pregnant</option>
          <option value="miscarriage">miscarriage</option>
          <option value="gave_birth">gave_birth</option>
          <option value="nursing">nursing</option>
        </select>
      </div>
      <div class="form-group"><label>Mating Date (optional)</label>
        <input type="date" id="sowEdit_mating_date" />
      </div>
      <button type="submit" class="btn-auth">Update</button>
    </form>
  </div></div>


  <!-- Archive/Success/Error -->
  <div id="archiveModal" class="modal"><div class="modal-content">
    <h3>‚ö†Ô∏è Are you sure you want to archive this record?</h3>
    <button onclick="archiveYes()">Yes, Archive</button>
    <button onclick="archiveNo()">Cancel</button>
  </div></div>

  <div id="successModal" class="modal"><div class="modal-content">
    <h3>‚úÖ Saved!</h3>
    <button onclick="closeModal('successModal')">OK</button>
  </div></div>

  <div id="errorModal" class="modal"><div class="modal-content">
    <h3>‚ùå Invalid Input!</h3>
    <button onclick="closeModal('errorModal')">OK</button>
  </div></div>

  <!-- Logic -->
  <script type="module">
import { authApi, getToken, clearToken, littersApi, pigsApi, healthApi, availApi } from "/_shared/api.js";
/* ===== Small JSON helper (Bearer) for Sows only ===== */
  async function sreq(path, { method="GET", body=null, params=null } = {}) {
    const API_BASE = "http://localhost:8000/api/api";                           // your app already mounted APIs at /api/...
    const url = new URL(API_BASE + path, window.location.origin);
    if (params) {
      Object.entries(params).forEach(([k,v])=>{
        if (v==null) return;
        Array.isArray(v) ? v.forEach(x=>url.searchParams.append(k,x))
                        : url.searchParams.append(k,v);
      });
    }
    const headers = { Accept: "application/json" };
    const token = getToken?.();
    if (token) headers.Authorization = `Bearer ${token}`;
    if (body !== null) { headers["Content-Type"] = "application/json"; body = JSON.stringify(body); }

    const res = await fetch(url, { method, headers, body });
    const text = await res.text();
    const isJson = (res.headers.get("content-type")||"").includes("application/json");
    if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
    return isJson ? JSON.parse(text) : text;
  }

  const sowsApi = {
    list:   (q)           => sreq("/sows", { params: q }),
    create: (data)        => sreq("/sows", { method:"POST", body:data }),
    get:    (id)          => sreq(`/sows/${id}`),
    update: (id, data)    => sreq(`/sows/${id}`, { method:"PUT", body:data }),
  };


/* ---------------- Auth guards ---------------- */
async function requireRoles(allowed = []) {
  const token = getToken();
  if (!token) { window.location.href = "/Zhomepage/login.html"; throw new Error("No token"); }

  let me;
  try { me = await authApi.me(); }
  catch (e) { clearToken(); window.location.href = "/Zhomepage/login.html"; throw e; }

  if (allowed.length) {
    const role = String(me.role?.value || me.role || "").toUpperCase();
    const ok = allowed.map(r => String(r).toUpperCase()).includes(role);
    if (!ok) {
      alert("You do not have access to this page.");
      window.location.href = "/Frontend/dashboard-admin.html";
      throw new Error("Forbidden");
    }
  }
  return me;
}
function logout(){ clearToken(); window.location.href = "/Zhomepage/login.html"; }

/* ---------------- Utils ---------------- */
const $ = (id) => document.getElementById(id);
const toISO = (d) => d ? new Date(d).toISOString() : null;
const fromISO = (iso) => {
  if (!iso) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  try { return new Date(iso).toISOString().slice(0, 10); } catch { return ""; }
};

/* ---------------- Tabs & Modals ---------------- */
// Tabs & Modals ‚Äî define ONCE, not wrapped, not redefined later
window.showView = (id) => {
  // switch visible section
  document.querySelectorAll(".record-view").forEach(s => s.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");

  // highlight tab button
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.querySelector(`.tab-btn[onclick="showView('${id}')"]`)?.classList.add("active");

  // tab-specific refreshes
  if (id === "available") {
    const status = document.getElementById("availableFilter")?.value || "available";
    loadAvailable(status);
  }
  if (id === "litter") {
    // (optional) reload litters if you want
    // loadLitters();
  }
  if (id === "individual") {
    // load pigs, etc., if you want
  }
  if (id === "health") {
    // load health, etc., if you want
  }
  if (id === "breeding") {
    loadSows();
  }
};

window.openModal  = (id) => $(id).style.display = "block";
window.closeModal = (id) => $(id).style.display = "none";
window.filterArchived = () => {
  const v = $("archiveFilter").value;
  document.querySelectorAll(".archived-section").forEach(sec => {
    const t = sec.getAttribute("data-type");
    sec.style.display = (v==="all" || v===t) ? "" : "none";
  });
};

/* ---------------- DOM refs ---------------- */
const litterTable  = $("litterTable");
const pigTable     = $("pigTable");
const healthTable  = $("healthTable");
const availableT   = $("availableTable");
const breedingTable = $("breedingTable"); 

const archivedLitter     = $("archivedLitter");
const archivedPig        = $("archivedPig");
const archivedHealth     = $("archivedHealth");
const archivedAvailable  = $("archivedAvailable");


const availableFilter = $("availableFilter");

function showError(msg) {
  // keep it quiet if you want; console only
  console.error(msg);
  // or show a toast/modal if you prefer:
  // alert(typeof msg === "string" ? msg : JSON.stringify(msg));
}


/* ---------------- Row factories ---------------- */
const tr = (html) => { const el = document.createElement("tr"); el.innerHTML = html; return el; };

function renderLitterRow(r) {
  const id    = r.litter_id ?? r.id;
  const sow   = r.sow_identifier ?? r.sow_tag ?? r.sow_id ?? "";
  const birth = fromISO?.(r.birth_date) ?? r.birth_date ?? "";
  const size  = r.litter_size ?? r.size ?? "";
  const row = tr(`
    <td>${id}</td>
    <td>${sow}</td>
    <td>${birth}</td>
    <td>${size}</td>
    <td>
      <button class="btn-edit"    data-action="edit"    data-type="litter">Edit</button>
      <button class="btn-archive" data-action="archive" data-type="litter">Archive</button>
    </td>
  `);
  row.dataset.id = id;
  return row;
}
function renderSowRow(r) {
  const id   = r.sow_id ?? r.id;
  const row  = document.createElement("tr");
  const fmt  = (v) => (v ? fromISO(v) : "");
  const overdue = r.is_overdue ? "Yes" : "No";
  row.dataset.id = id;

  row.innerHTML = `
    <td>${id}</td>
    <td>${r.sow_identifier ?? ""}</td>
    <td>${r.status ?? ""}</td>
    <td>${fmt(r.mating_date)}</td>
    <td>${fmt(r.expected_birth)}</td>
    <td>${fmt(r.last_birth_date)}</td>
    <td>${r.caretaker_id ?? ""}</td>
    <td>${overdue}</td>
    <td>
      <button class="btn-edit" data-action="edit" data-type="breeding">Edit</button>
      <button class="btn-archive" data-action="archive" data-type="breeding">Archive</button>
    </td>
  `;
  return row;
}


function renderPigRow(r) {
  const pigId  = r.pig_id ?? r.pigs_id ?? r.id;
  const litter = r.litter_id ?? "";
  const sow    = r.sow_identifier ?? r.sow_tag ?? "";
  const birth  = fromISO(r.birth_date);
  const status = r.status ?? "";
  const notes  = r.notes ?? "";
  const row = tr(`
    <td>${pigId}</td>
    <td>${litter}</td>
    <td>${sow}</td>
    <td>${birth}</td>
    <td>${status}</td>
    <td>${notes}</td>
    <td>
      <button class="btn-edit"    data-action="edit"    data-type="pig">Edit</button>
      <button class="btn-archive" data-action="archive" data-type="pig">Archive</button>
    </td>
  `);
  row.dataset.id = pigId;
  return row;
}

function renderHealthRow(r) {
  const id = r.health_record_id ?? r.id ?? "";
  const pigId = r.pig_id ?? r.pigs_id ?? "";
  const row = tr(`
    <td>${id}</td>
    <td>${pigId}</td>
    <td>${r.diagnosis ?? ""}</td>
    <td>${r.treatment ?? ""}</td>
    <td>${fromISO(r.recorded_at)}</td>
    <td>
      <button class="btn-edit"    data-action="edit"    data-type="health">Edit</button>
      <button class="btn-archive" data-action="archive" data-type="health">Archive</button>
    </td>
  `);
  row.dataset.id = id;
  return row;
}

/* ===== Available Pigs: renderer & loader ===== */
function availableRow(r) {
  const row = tr(`
    <td>${r.id ?? "-"}</td>
    <td>${r.pigs_id ?? "-"}</td>
    <td>${r.weight_kg ?? "-"}</td>
    <td>${r.sale_type ?? "-"}</td>
    <td>${r.status ?? "-"}</td>
    <td>${(r.created_at ?? "").toString().slice(0,19).replace("T"," ")}</td>
    <td>${(r.updated_at ?? "").toString().slice(0,19).replace("T"," ")}</td>
    <td>
      <button class="btn-edit"    data-action="edit"    data-type="available">Edit</button>
      <button class="btn-archive" data-action="archive" data-type="available">Archive</button>
    </td>
  `);
  row.dataset.id = r.id ?? "";
  return row;
}

async function loadSows() {
  if (!breedingTable) return;
  breedingTable.innerHTML = "";
  const rows = await sowsApi.list();                   // GET /api/sows
  (rows || []).forEach(s => breedingTable.appendChild(renderSowRow(s)));
}


async function loadAvailable(status = "available") {
  if (!availableT) return;
  availableT.innerHTML = "";

  // normalize from UI ("All", "Available", etc.) to lowercase tokens
  const normalized = String(status || "available").toLowerCase();

  // Build params for GET /available-pigs
  // If your backend accepts "all", pass it; otherwise omit status completely.
  const params = normalized === "all" ? { status: "all" } : { status: normalized };

  try {
    const rows = await availApi.list(params); // GET /available-pigs?status=...
    if (!rows || rows.length === 0) {
      availableT.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#777;">No records</td></tr>`;
      return;
    }
    rows.forEach(r => availableT.appendChild(availableRow(r)));
  } catch (e) {
    showError("Load available pigs failed: " + (e?.message ?? e));
  }
}

availableFilter?.addEventListener("change", () => {
  loadAvailable(availableFilter.value || "available");
});

/* Build dropdown for Add Available Pig */
async function buildAvailablePigOptions() {
  const sel = $("avPigId");
  if (!sel) return;

  sel.innerHTML = `<option value="" disabled selected>Loading...</option>`;

  const [allPigs, listings] = await Promise.all([
    pigsApi.list(),
    availApi.list({ status: "all" })
  ]);

  const excluded = new Set(
    (listings || [])
      .filter(x => x.status !== "removed") // keep removed selectable
      .map(x => String(x.pigs_id))
  );

  const choices = (allPigs || [])
    .map(p => p.pig_id ?? p.pigs_id ?? p.id)
    .filter(id => id != null && !excluded.has(String(id)));

  sel.innerHTML = `<option value="" disabled selected>Select Pigs ID</option>` +
    choices.map(id => `<option value="${id}">${id}</option>`).join("");
}

/* Open Add: build choices each time */
window.openModal = ((orig) => (id) => {
  if (id === "addAvailableModal") buildAvailablePigOptions();
  orig(id);
})(window.openModal);

/* Add & Edit submit handlers (Available) */
$("addAvailableForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    pigs_id:  Number($("avPigId").value),
    weight_kg: Number($("avWeight").value),
    sale_type: $("avSaleType").value,
    notes:     ($("avNotes").value || undefined)
  };
  if (!payload.pigs_id || !payload.weight_kg) return openModal("errorModal");
  await availApi.create(payload);
  closeModal("addAvailableModal");
  await loadAvailable(availableFilter?.value || "available");
});

let _editAvailId = null;
function openEditAvailable(row) {
  _editAvailId = row?.dataset?.id;
  if (!_editAvailId) return;
  $("editAvWeight").value   = row.cells[2].innerText.replace(/,/g,"");
  $("editAvSaleType").value = row.cells[3].innerText.trim();
  $("editAvNotes").value    = "";
  openModal("editAvailableModal");
}
$("editAvailableForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!_editAvailId) return closeModal("editAvailableModal");
  const body = {
    weight_kg: Number($("editAvWeight").value),
    sale_type: $("editAvSaleType").value,
    notes:     ($("editAvNotes").value || undefined)
  };
  await availApi.update(_editAvailId, body);
  closeModal("editAvailableModal");
  _editAvailId = null;
  await loadAvailable(availableFilter?.value || "available");
});

/* ---------------- Load all (other tabs) ---------------- */
async function loadAll() {
  // Litters
  litterTable.innerHTML = "";
  const litters = await littersApi.list();
  (litters || []).forEach(l => litterTable.appendChild(renderLitterRow(l)));

  // Pigs
  pigTable.innerHTML = "";
  const pigs = await pigsApi.list();
  (pigs || []).forEach(p => pigTable.appendChild(renderPigRow(p)));

  // Health
  healthTable.innerHTML = "";
  const hs = await healthApi.listPigRecords();
  (hs || []).forEach(h => healthTable.appendChild(renderHealthRow(h)));
}

/* ---------------- Delegated click actions ---------------- */
document.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;

  const action = btn.dataset.action;    // edit | archive | restore
  const type   = btn.dataset.type;      // litter | pig | health | available
  const row    = btn.closest("tr");

  if (action === "edit" && type === "available") return openEditAvailable(row);
  if (action === "edit" && type === "breeding") return openEditSow(row);
  if (action === "edit")    return openEdit(type, row);
  if (action === "archive") return openArchive(row, type);
  if (action === "restore") return restoreRecord(row, type);
});

/* ---------------- Generic edit openers (other tabs) ---------------- */
function openEdit(type, row) {
  window._editRow = row; window._editType = type;
  const c = row.cells;

  if (type === "litter") {
    $("editLitterSow").value   = c[1].innerText;
    $("editLitterBirth").value = c[2].innerText;
    $("editLitterSize").value  = c[3].innerText;
    openModal("editLitterModal");
  }
  if (type === "pig") {
    $("editPigLitter").value = c[1].innerText;
    $("editPigSow").value    = c[2].innerText;
    $("editPigBirth").value  = c[3].innerText;
    $("editPigStatus").value = (c[4].innerText || "").toLowerCase();
    $("editPigNotes").value  = c[5].innerText;
    openModal("editPigModal");
  }
  if (type === "health") {
    $("editHealthPig").value        = c[1].innerText;
    $("editHealthDiagnosis").value  = c[2].innerText;
    $("editHealthTreatment").value  = c[3].innerText;
    $("editHealthDate").value       = c[4].innerText;
    openModal("editHealthModal");
  }
  }
  function openEditSow(row) {
    const c = row.children;
    document.getElementById("sowEdit_identifier").value = c[1].innerText;
    document.getElementById("sowEdit_status").value     = (c[2].innerText || "").toLowerCase();
    document.getElementById("sowEdit_mating_date").value= c[3].innerText || "";
    window._editRow = row; window._editType = "breeding";
    openModal("editBreedingModal");
  }


/* ---------------- Generic Update (other tabs) ---------------- */
window.updateRecord = async (e, type) => {
  e.preventDefault();
  const row = window._editRow; if (!row) return false;
  const id = row.dataset.id;

  try {
    if (type === "litter") {
      const payload = {
        sow_identifier: $("editLitterSow").value.trim(),
        birth_date:     $("editLitterBirth").value,
        litter_size:    Number($("editLitterSize").value || 0)
      };
      const updated = await littersApi.update(id, payload);
      row.replaceWith(renderLitterRow(updated));
      closeModal("editLitterModal"); openModal("successModal");
    }

    if (type === "pig") {
      const payload = {
        litter_id:       Number($("editPigLitter").value),
        sow_identifier:  $("editPigSow").value.trim(),
        birth_date:      $("editPigBirth").value,
        status:          $("editPigStatus").value,
        notes:           $("editPigNotes").value.trim() || null
      };
      const updated = await pigsApi.update(id, payload);
      row.replaceWith(renderPigRow(updated));
      closeModal("editPigModal"); openModal("successModal");
    }

    if (type === "health") {
      const payload = {
        pig_id:       Number($("editHealthPig").value),
        diagnosis:    $("editHealthDiagnosis").value.trim(),
        treatment:    $("editHealthTreatment").value.trim() || null,
        recorded_at:  $("editHealthDate").value ? toISO($("editHealthDate").value) : null
      };
      const updated = await healthApi.updatePigRecord(id, payload);
      row.replaceWith(renderHealthRow(updated));
      closeModal("editHealthModal"); openModal("successModal");
    }
  } catch (err) {
    alert("Update failed: " + err.message);
  }
  return false;
};

/* ---------------- Front-end Archive (localStorage) ---------------- */
/* ---------------- Create (Add) for each tab ---------------- */
window.addRecord = async (e, type) => {
  e.preventDefault();
  e.stopPropagation();

  try {
    if (type === "litter") {
      const payload = {
        sow_identifier: $("litterSow").value.trim(),
        birth_date: $("litterBirth").value,
        litter_size: Number($("litterSize").value || 0)
      };
      if (!payload.sow_identifier || !payload.birth_date) return openModal("errorModal");

      const created = await littersApi.create(payload);
      litterTable.appendChild(renderLitterRow(created));
      closeModal("addLitterModal");
      openModal("successModal");
      return false;
    }

    if (type === "pig") {
      const payload = {
        litter_id: Number($("pigLitter").value),
        sow_identifier: $("pigSow").value.trim(),
        birth_date: $("pigBirth").value,
        status: $("pigStatus").value,
        notes: $("pigNotes").value.trim() || null
      };
      if (!payload.litter_id || !payload.sow_identifier || !payload.birth_date) return openModal("errorModal");

      const created = await pigsApi.create(payload);
      pigTable.appendChild(renderPigRow(created));
      closeModal("addPigModal");
      openModal("successModal");
      return false;
    }

    if (type === "health") {
      const payload = {
        pig_id: Number($("healthPig").value),
        diagnosis: $("healthDiagnosis").value.trim(),
        treatment: $("healthTreatment").value.trim() || null,
        recorded_at: $("healthDate").value ? toISO($("healthDate").value) : null
      };
      if (!payload.pig_id || !payload.diagnosis) return openModal("errorModal");

      const created = await healthApi.createPigRecord(payload);
      healthTable.appendChild(renderHealthRow(created));
      closeModal("addHealthModal");
      openModal("successModal");
      return false;
    }

    if (type === "breeding") {
      // Create Sow
      const payload = {
        sow_identifier: document.getElementById("sowCreate_identifier").value.trim(),
        status: document.getElementById("sowCreate_status").value,
        // optional
        mating_date: document.getElementById("sowCreate_mating_date").value || null,
      };
      if (!payload.sow_identifier || !payload.status) return openModal("errorModal");

      const created = await sowsApi.create(payload);
      breedingTable.appendChild(renderSowRow(created));
      closeModal("addBreedingModal");
      openModal("successModal");
      return false;
    }

  } catch (err) {
    console.error("Add failed:", err);
    openModal("errorModal");
  }
  return false;
};

  document.getElementById("editSowForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const row = window._editRow; if (!row) return;
    const id = row.dataset.id;

    const payload = {
      sow_identifier: document.getElementById("sowEdit_identifier").value.trim(),
      status: document.getElementById("sowEdit_status").value,
      mating_date: document.getElementById("sowEdit_mating_date").value || null,
    };

    const updated = await sowsApi.update(id, payload);
    row.replaceWith(renderSowRow(updated));
    closeModal("editBreedingModal");
    openModal("successModal");
  });


const ARCHIVE_KEYS = {
  litter: "arch_litters",
  pig: "arch_pigs",
  health: "arch_health",
  available: "arch_available",
  breeding: "arch_breeding"
};


function getArchived(kind){
  try { const raw = localStorage.getItem(ARCHIVE_KEYS[kind]); const arr = JSON.parse(raw || "[]"); return Array.isArray(arr) ? arr : []; }
  catch { return []; }
}
function setArchived(kind, rows){ localStorage.setItem(ARCHIVE_KEYS[kind], JSON.stringify(Array.isArray(rows) ? rows : [])); }

function rowToObj(kind, tr) {
  const c = tr.cells;
  if (kind === "litter")  return { _id:c[0].innerText.trim(), litter_id:c[0].innerText.trim(), sow_identifier:c[1].innerText.trim(), birth_date:c[2].innerText.trim(), litter_size:c[3].innerText.trim() };
  if (kind === "pig")     return { _id:c[0].innerText.trim(), id:c[0].innerText.trim(), litter_id:c[1].innerText.trim(), sow_identifier:c[2].innerText.trim(), birth_date:c[3].innerText.trim(), status:c[4].innerText.trim(), notes:c[5].innerText.trim() };
  if (kind === "available") return { _id:c[0].innerText.trim(), id:c[0].innerText.trim(), pigs_id:c[1].innerText.trim(), weight_kg:c[2].innerText.trim(), sale_type:c[3].innerText.trim(), status:c[4].innerText.trim(), created_at:c[5].innerText.trim(), updated_at:c[6].innerText.trim() };
  if (kind === "breeding") {
    // live breeding columns: 0 id, 1 sow_identifier, 2 status, 3 mating_date,
    // 4 expected_birth, 5 last_birth_date, 6 caretaker_id, 7 overdue, 8 actions
    const overTxt = (c[7]?.innerText || "").trim().toLowerCase();
    return {
      _id: c[0].innerText.trim(),
      sow_id: c[0].innerText.trim(),
      sow_identifier: c[1].innerText.trim(),
      status: c[2].innerText.trim(),
      mating_date: c[3].innerText.trim(),
      expected_birth: c[4].innerText.trim(),
      last_birth_date: c[5].innerText.trim(),
      caretaker_id: c[6].innerText.trim(),
      is_overdue: overTxt === "yes"
    };
  }

  // health
  return { _id:c[0].innerText.trim(), health_record_id:c[0].innerText.trim(), pig_id:c[1].innerText.trim(), diagnosis:c[2].innerText.trim(), treatment:c[3].innerText.trim(), recorded_at:c[4].innerText.trim() };
}

function objToRow(kind, obj, { live }){
  const el = document.createElement("tr");
  if (kind === "litter") {
    const sow = obj.sow_identifier ?? obj.sow_id ?? obj.sow_tag ?? "";
    el.innerHTML = live ? `
      <td>${obj.litter_id}</td><td>${sow}</td><td>${obj.birth_date||""}</td><td>${obj.litter_size||""}</td>
      <td><button class="btn-edit" data-action="edit" data-type="litter">Edit</button>
          <button class="btn-archive" data-action="archive" data-type="litter">Archive</button></td>`
    : `
      <td>${obj.litter_id}</td><td>${sow}</td><td>${obj.birth_date||""}</td><td>${obj.litter_size||""}</td>
      <td><button class="btn-restore" data-action="restore" data-type="litter">Restore</button></td>`;
    return el;
  }
  if (kind === "pig") {
    el.innerHTML = live ? `
      <td>${obj.id}</td><td>${obj.litter_id||""}</td><td>${obj.sow_identifier||""}</td><td>${obj.birth_date||""}</td><td>${obj.status||""}</td><td>${obj.notes||""}</td>
      <td><button class="btn-edit" data-action="edit" data-type="pig">Edit</button>
          <button class="btn-archive" data-action="archive" data-type="pig">Archive</button></td>`
    : `
      <td>${obj.id}</td><td>${obj.litter_id||""}</td><td>${obj.sow_identifier||""}</td><td>${obj.birth_date||""}</td><td>${obj.status||""}</td><td>${obj.notes||""}</td>
      <td><button class="btn-restore" data-action="restore" data-type="pig">Restore</button></td>`;
    return el;
  }
  if (kind === "available") {
    const content = `
      <td>${obj.id}</td><td>${obj.pigs_id ?? ""}</td><td>${Number(obj.weight_kg ?? 0).toFixed(2)}</td>
      <td>${obj.sale_type ?? ""}</td><td>${obj.status ?? ""}</td><td>${obj.created_at ?? ""}</td><td>${obj.updated_at ?? ""}</td>`;
    el.innerHTML = live
      ? content + `<td><button class="btn-edit" data-action="edit" data-type="available">Edit</button>
                      <button class="btn-archive" data-action="archive" data-type="available">Archive</button></td>`
      : content + `<td><button class="btn-restore" data-action="restore" data-type="available">Restore</button></td>`;
    return el;
  }
  if (kind === "breeding") {
    const over = obj.is_overdue ? "Yes" : "No";
    const content = `
      <td>${obj.sow_id ?? obj._id}</td>
      <td>${obj.sow_identifier ?? ""}</td>
      <td>${obj.status ?? ""}</td>
      <td>${obj.mating_date ?? ""}</td>
      <td>${obj.expected_birth ?? ""}</td>
      <td>${obj.last_birth_date ?? ""}</td>
      <td>${obj.caretaker_id ?? ""}</td>
      <td>${over}</td>`;
    const el = document.createElement("tr");
    el.innerHTML = live
      ? content + `<td><button class="btn-edit" data-action="edit" data-type="breeding">Edit</button>
                      <button class="btn-archive" data-action="archive" data-type="breeding">Archive</button></td>`
      : content + `<td><button class="btn-restore" data-action="restore" data-type="breeding">Restore</button></td>`;
    return el;
  }
  el.innerHTML = live ? `
    <td>${obj.health_record_id}</td><td>${obj.pig_id ?? ""}</td><td>${obj.diagnosis ?? ""}</td><td>${obj.treatment ?? ""}</td><td>${obj.recorded_at ?? ""}</td>
    <td><button class="btn-edit" data-action="edit" data-type="health">Edit</button>
        <button class="btn-archive" data-action="archive" data-type="health">Archive</button></td>`
  : `
    <td>${obj.health_record_id}</td><td>${obj.pig_id ?? ""}</td><td>${obj.diagnosis ?? ""}</td><td>${obj.treatment ?? ""}</td><td>${obj.recorded_at ?? ""}</td>
    <td><button class="btn-restore" data-action="restore" data-type="health">Restore</button></td>`;
  return el;
    
}

function renderArchivedOnLoad(){
  const mapping = [
    ["litter","archivedLitter"],
    ["pig","archivedPig"],
    ["health","archivedHealth"],
    ["available","archivedAvailable"],
    ["breeding","archivedBreeding"],
  ];

  for (const [kind, tbodyId] of mapping) {
    const tbody = $(tbodyId);
    if (!tbody) continue;
    tbody.innerHTML = "";
    getArchived(kind).forEach(o => tbody.appendChild(objToRow(kind, o, { live:false })));
  }
}
function pruneLiveTablesUsingStorage(){
    const map = [
      ["litter","litterTable"],
      // ["pig","pigTable"],
      ["health","healthTable"],
      ["available","availableTable"],
      ["breeding","breedingTable"],
    ];

  for (const [kind, tbodyId] of map) {
    const tbody = $(tbodyId); if (!tbody) continue;
    const archivedIds = new Set(getArchived(kind).map(o => String(o._id)));
    [...tbody.querySelectorAll("tr")].forEach(tr => {
      const first = tr.cells?.[0]?.innerText?.trim();
      if (archivedIds.has(String(first))) tr.remove();
    });
  }
}

window.archiveYes = () => {
  const row = window._archiveRow;
  const type = window._archiveType;
  if (!row) return closeModal("archiveModal");

  const obj = rowToObj(type, row);
  const arr = getArchived(type);
  if (!arr.some(x => String(x._id) === String(obj._id))) { arr.push(obj); setArchived(type, arr); }

const target = type === "litter"   ? "archivedLitter"   :
               type === "pig"      ? "archivedPig"      :
               type === "health"   ? "archivedHealth"   :
               type === "available"? "archivedAvailable":
               /* breeding */        "archivedBreeding";

  $(target).appendChild(objToRow(type, obj, { live:false }));

  row.remove();
  closeModal("archiveModal");
};
window.archiveNo = () => closeModal("archiveModal");

function openArchive(row, type){
  window._archiveRow = row;
  window._archiveType = type;
  openModal("archiveModal");
}

function restoreRecord(row, type){
  const obj = rowToObj(type, row);
  const left = getArchived(type).filter(x => String(x._id) !== String(obj._id));
  setArchived(type, left);

const target = type === "litter"   ? "litterTable"   :
               type === "pig"      ? "pigTable"      :
               type === "health"   ? "healthTable"   :
               type === "available"? "availableTable":
               /* breeding */        "breedingTable";

  const tbody = $(target);
  const exists = [...tbody.querySelectorAll("tr")].some(tr =>
    String(tr.cells?.[0]?.innerText?.trim()) === String(obj._id)
  );
  if (!exists) tbody.appendChild(objToRow(type, obj, { live:true }));

  row.remove();
}
window.restoreRecord = restoreRecord;

/* ---------------- Modal backdrop close ---------------- */
window.addEventListener("click", (e) => {
  document.querySelectorAll(".modal").forEach(m => { if (e.target === m) m.style.display = "none"; });
});
window.addEventListener("keydown", (e) => { if (e.key === "Escape") document.querySelectorAll(".modal").forEach(m => m.style.display = "none"); });

/* ---------------- Init ---------------- */
(async function init(){
  try{
    await requireRoles(["ADMIN", "CARETAKER"]);
    document.getElementById("logoutLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      logout(); // calls clearToken() and redirects to /Zhomepage/login.html
    });


    await loadAll();
    await loadAvailable(availableFilter?.value || "available");
    await loadSows();


    renderArchivedOnLoad();
    pruneLiveTablesUsingStorage();
  }catch(err){
    console.error("Init failed:", err);
  }
})();
</script>
</body>
</html>
