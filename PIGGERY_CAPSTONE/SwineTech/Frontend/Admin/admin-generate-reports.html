<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Reports</title>
  <link rel="stylesheet" href="/Admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Small helpers so table in modal looks good */
    .report-data pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
      max-height: 50vh;
    }
    .admin-table td .btn {
      margin-right: 6px;
    }
    .btn {
      padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer;
      background: #334155; color: #fff;
    }
    .btn:hover { background: #475569; }
    .btn-ghost { background: #EF5350; color: #e2e8f0; }
    
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-admin.html"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</a>
      <a href="admin-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="admin-manage-user-accounts.html"><i class="fa-solid fa-users"></i> Manage User Accounts</a>
      <a href="admin-manage-pig-records.html"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="admin-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedule</a>
      <a href="admin-manage-supplies.html"><i class="fa-solid fa-boxes-stacked"></i> Manage Supplies</a>
      <a href="admin-manage-sales-expenses-bookings.html"><i class="fa-solid fa-money-bill-trend-up"></i> Manage Sales, Expenses & Bookings</a>
      <a href="admin-manage-client-feedback-admin.html"><i class="fa-solid fa-comment-dots"></i> Manage Client Feedback</a>
      <a href="admin-generate-reports.html" class="active"><i class="fa-solid fa-file-lines"></i> Generate Reports</a>
      <a href="#" id="logoutLink" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard">
    <h1>Reports</h1>
    <p class="page-desc">
      Generate and view system reports such as Sales, Profit & Loss, Mortality, Feed Consumption, and Inventory.
    </p>

    <!-- Generate Report Form -->
    <form id="report-form" class="report-filter">
      <label for="report-type">Report Type:</label>
      <select id="report-type" name="report-type" required>
        <option value="sales">Sales</option>
        <option value="profit_loss">Profit &amp; Loss</option>
        <option value="mortality">Mortality</option>
        <option value="feed_consumption">Feed Consumption</option>
        <option value="inventory">Inventory Usage</option>
      </select>

      <label for="date-from">From:</label>
      <input type="date" id="date-from" name="date-from">

      <label for="date-to">To:</label>
      <input type="date" id="date-to" name="date-to">

      <button type="submit" class="btn-generate">
        <i class="fa-solid fa-filter"></i> Generate Report
      </button>
    </form>

    <div class="tabs" style="margin: 8px 0 16px;">
      <button id="tab-reports"  class="btn">Reports</button>
      <button id="tab-archived" class="btn btn-ghost">Archived</button>
    </div>

    <div id="section-reports">
      <h2><i class="fa-solid fa-clock-rotate-left"></i> Previously Generated Reports</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Report ID</th>
            <th>Type</th>
            <th>Generated By</th>
            <th>Date Generated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="history-tbody"></tbody>
      </table>
    </div>

    <div id="section-archived" style="display:none">
      <h2><i class="fa-solid fa-box-archive"></i> Archived Reports</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Report ID</th>
            <th>Type</th>
            <th>Generated By</th>
            <th>Date Generated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="archive-tbody"></tbody>
      </table>
    </div>



  <!-- Report Modal -->
  <div id="reportModal" class="modal" style="display:none">
    <div class="modal-content">
      <span class="close" id="modal-close">&times;</span>
      <h2>Report Details</h2>
      <p><strong>Report Type:</strong> <span id="modal-report-type">‚Äî</span></p>
      <p><strong>Generated At:</strong> <span id="modal-generated-at">‚Äî</span></p>
      <p><strong>Generated By:</strong> <span id="modal-generated-by">‚Äî</span></p>

      <!-- Chart area -->
      <div class="chart-box" style="margin:12px 0">
        <canvas id="report-chart" height="160"></canvas>
      </div>

      <div class="report-data">
        <h3>Report Content</h3>
        <pre id="modal-report-data">Report details will appear here...</pre>
      </div>

      <div class="report-actions" style="margin-top:12px">
        <button class="btn" id="btn-export"><i class="fa-solid fa-file-excel"></i> Export CSV</button>
        <button class="btn btn-ghost" id="btn-pdf"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
        <button class="btn" id="btn-print"><i class="fa-solid fa-print"></i> Print</button>
      </div>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
  import { authApi, reportsApi } from "../_shared/api.js";

  // ---------- Auth (no role gates; just who am I for "Generated By") ----------
  let me = { username: "admin" };
  try { me = await authApi.me(); } catch {}

  // ---------- DOM ----------
  const form          = document.getElementById("report-form");
  const selType       = document.getElementById("report-type");
  const inpFrom       = document.getElementById("date-from");
  const inpTo         = document.getElementById("date-to");

  const historyTbody  = document.getElementById("history-tbody");
  const archivedTbody = document.getElementById("archive-tbody");

  // Modal
  const modal         = document.getElementById("reportModal");
  const modalClose    = document.getElementById("modal-close");
  const mType         = document.getElementById("modal-report-type");
  const mGenAt        = document.getElementById("modal-generated-at");
  const mGenBy        = document.getElementById("modal-generated-by");
  const mPre          = document.getElementById("modal-report-data"); // still used for CSV/Debug

  const btnExport     = document.getElementById("btn-export");
  const btnPrint      = document.getElementById("btn-print");
  const btnPdf        = document.getElementById("btn-pdf");

  // ========== CHARTS ==========
let chart;                                // single chart instance
const chartCanvas = document.getElementById("report-chart");

function resetChart() {                   // destroy if we re-open the modal
  if (chart) { chart.destroy(); chart = null; }
}
function ensureChartCtx() {               // safe ctx getter
  return chartCanvas.getContext("2d");
}

// Sales ‚Äî stacked bar of Revenue / Expenses + Profit line (from by_month)
function drawSalesChart(data) {
  const rows = Array.isArray(data.by_month) ? data.by_month : [];
  const labels   = rows.map(r => r.month);
  const revenue  = rows.map(r => Number(r.revenue  || 0));
  const expenses = rows.map(r => Number(r.expenses || 0));
  const profit   = rows.map((r,i) => Number((revenue[i] || 0) - (expenses[i] || 0)));

  // If there‚Äôs no monthly breakdown, show a simple 3-bar summary instead
  if (!labels.length) {
    chart = new Chart(ensureChartCtx(), {
      type: "bar",
      data: {
        labels: ["Revenue", "Expenses", "Profit"],
        datasets: [{ label: "Amount", data: [
          Number(data.revenue || 0),
          Number(data.expenses || 0),
          Number(data.profit || 0),
        ]}]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
    return;
  }

  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Revenue",  data: revenue },
        { label: "Expenses", data: expenses },
        { label: "Profit",   data: profit, type: "line", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  });
}

// Mortality ‚Äî bar by diagnosis
function drawMortalityChart(data) {
  const rows = Array.isArray(data.by_cause) ? data.by_cause : [];
  const labels = rows.map(r => r.diagnosis || "Unknown");
  const values = rows.map(r => Number(r.cases || 0));
  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: { labels, datasets: [{ label: "Cases", data: values }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// Feed Consumption ‚Äî bar by feed type (kg)
function drawFeedChart(data) {
  const rows = Array.isArray(data.by_feed_type) ? data.by_feed_type : [];
  const labels = rows.map(r => r.feed_type || "Unknown");
  const values = rows.map(r => Number(r.kg || 0));
  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: { labels, datasets: [{ label: "Kg", data: values }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// Inventory ‚Äî top 10 quantities by item
function drawInventoryChart(data) {
  const items = Array.isArray(data.items) ? data.items : [];
  const top = items
    .map(it => ({ name: it.item_name, qty: Number(it.quantity || 0) }))
    .sort((a,b) => b.qty - a.qty)
    .slice(0, 10);
  const labels = top.map(x => x.name);
  const values = top.map(x => x.qty);
  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: { labels, datasets: [{ label: "Quantity", data: values }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}


  // --- Tabs (Reports / Archived) ---
  const tabReports      = document.getElementById("tab-reports");
  const tabArchived     = document.getElementById("tab-archived");
  const sectionReports  = document.getElementById("section-reports");
  const sectionArchived = document.getElementById("section-archived");

  function showReports() {
    sectionReports.style.display  = "";
    sectionArchived.style.display = "none";
    tabReports.classList.remove("btn-ghost");
    tabArchived.classList.add("btn-ghost");
  }
  function showArchived() {
    sectionReports.style.display  = "none";
    sectionArchived.style.display = "";
    tabArchived.classList.remove("btn-ghost");
    tabReports.classList.add("btn-ghost");
    // ensure archived list is fresh when you switch
    // (loadAndRenderLists renders both sections; no extra call needed)
  }

  tabReports.onclick  = showReports;
  tabArchived.onclick = showArchived;

  // default view
  showReports();


  // ---------- Archive (frontend-only) ----------
  const ARCHIVE_KEY = "archived_report_ids";
  const getArchived = () => {
    try { return new Set(JSON.parse(localStorage.getItem(ARCHIVE_KEY) || "[]")); }
    catch { return new Set(); }
  };
  const setArchived = (set) => {
    localStorage.setItem(ARCHIVE_KEY, JSON.stringify([...set]));
  };

  // ---------- Helpers ----------
  const peso = (n) =>
    "‚Ç±" + (Number(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const asLocalDateTime = (v) => {
    if (!v) return "";
    const d = new Date(v);
    const pad = (x) => (x < 10 ? "0" : "") + x;
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };

  const prettyType = (t) => ({
    sales: "Sales (Revenue, Expenses & Profit)",
    mortality: "Mortality",
    feed_consumption: "Feed Consumption",
    inventory: "Inventory",
  })[t] || t;


  // ---------- CSV (flatten major arrays) ----------
  function exportCSV(report) {
    const rows = [];
    const pushObject = (obj) => {
      const cols = Object.keys(obj);
      if (!rows.length) rows.push(cols.join(","));
      rows.push(cols.map(c => csvEscape(obj[c])).join(","));
    };

    // Choose which array to flatten
    if (report?.type === "sales" && Array.isArray(report.by_month) && report.by_month.length) {
      report.by_month.forEach(pushObject);
    } else if (report?.type === "mortality" && Array.isArray(report.by_cause) && report.by_cause.length) {
      report.by_cause.forEach(pushObject);
    } else if (report?.type === "feed_consumption" && Array.isArray(report.by_feed_type) && report.by_feed_type.length) {
      report.by_feed_type.forEach(pushObject);
    } else if (report?.type === "inventory" && Array.isArray(report.items) && report.items.length) {
      report.items.forEach(pushObject);
    } else {
      pushObject(report || {});
    }

    const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `report_${(report?.type || "data")}_${Date.now()}.csv`;
    a.click();
  }
  const csvEscape = (v) => {
    if (v == null) return "";
    const s = typeof v === "object" ? JSON.stringify(v) : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };

  // ---------- Modal wire ----------
  modalClose.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
  btnPrint.onclick = () => window.print();
  btnPdf.onclick   = () => window.print(); // keep as print

  // ---------- List + Archive rendering ----------
  async function loadAndRenderLists() {
    const archived = getArchived();
    const list = await reportsApi.list(); // server-stored reports

    // Render visible (not archived)
    historyTbody.innerHTML = "";
    list.filter(r => !archived.has(r.id)).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${prettyType(r.type || r.report_type)}</td>
        <td>${r.generated_by || "admin"}</td>
        <td>${asLocalDateTime(r.generated_at)}</td>
        <td>
          <button class="btn btn-view">View</button>
          <button class="btn btn-ghost btn-archive">Archive</button>
        </td>
      `;
      tr.querySelector(".btn-view").onclick = async () => {
        const full = await reportsApi.get(r.id);
        openReportModal(full);
      };
      tr.querySelector(".btn-archive").onclick = () => {
        archived.add(r.id);
        setArchived(archived);
        loadAndRenderLists();
      };
      historyTbody.appendChild(tr);
    });

    // Render archived table
    archivedTbody.innerHTML = "";
    list.filter(r => archived.has(r.id)).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${prettyType(r.type || r.report_type)}</td>
        <td>${r.generated_by || "admin"}</td>
        <td>${asLocalDateTime(r.generated_at)}</td>
        <td><button class="btn btn-ghost btn-restore">Restore</button></td>
      `;
      tr.querySelector(".btn-restore").onclick = () => {
        archived.delete(r.id);
        setArchived(archived);
        loadAndRenderLists();
      };
      archivedTbody.appendChild(tr);
    });
  }

// --- Normalise any row to { type, data, generated_at, generated_by }
  function normalizeReportRow(rowOrData) {
    // Server row shape: { id, report_type, generated_by, generated_at, data }
    // Old local shape  : { type, ... } or { payload: {...} }
    const data =
      rowOrData?.data ??
      rowOrData?.payload ??           // local history entry you saved earlier
      rowOrData?.a ??                 // safety for your screenshot showing "a"
      rowOrData;                      // allow direct report object

    const type =
      rowOrData?.report_type ??
      data?.type ??
      "sales";

    const generated_at =
      rowOrData?.generated_at ??
      new Date().toISOString();

    const generated_by =
      rowOrData?.generated_by ?? (window.me?.username || "admin");

    // sensible defaults; backend sometimes may omit
    const d = data || {};
    d.revenue   = Number(d.revenue   ?? 0);
    d.expenses  = Number(d.expenses  ?? 0);
    d.profit    = Number(d.profit    ?? 0);
    d.by_month  = Array.isArray(d.by_month) ? d.by_month : [];
    d.window    = d.window || { from: null, to: null };

    return { type, data: d, generated_at, generated_by };
  }

  function openReportModal(rowOrData) {
    const { type, data, generated_at, generated_by } = normalizeReportRow(rowOrData);


    // header fields
    document.getElementById("modal-report-type").textContent = prettyType(type);
    document.getElementById("modal-generated-at").textContent =
      new Date(generated_at).toLocaleString();
    document.getElementById("modal-generated-by").textContent = generated_by;

    // numbers & window
    const peso = (n) =>
      `‚Ç±${(Number(n) || 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

    // If you still have a "black window box" element before .report-data, update its fields
    const windowBox = document.querySelector(".report-data")?.previousElementSibling;
    if (windowBox && /window/i.test(windowBox.textContent || "")) {
      const fromEl = windowBox.querySelector ? windowBox.querySelector(".window-from") : null;
      const toEl   = windowBox.querySelector ? windowBox.querySelector(".window-to")   : null;
      if (fromEl) fromEl.textContent = data?.window?.from ?? "‚Äî";
      if (toEl)   toEl.textContent   = data?.window?.to   ?? "‚Äî";
    }

    // If you printed revenue/expenses/profit directly in the modal somewhere:
    document.querySelectorAll(".js-rev").forEach(el => (el.textContent = peso(data?.revenue)));
    document.querySelectorAll(".js-exp").forEach(el => (el.textContent = peso(data?.expenses)));
    document.querySelectorAll(".js-profit").forEach(el => (el.textContent = peso(data?.profit)));

    // Replace the <pre> content with a quick readable summary
    // Replace the <pre> content with a quick readable summary
    const pre = document.getElementById("modal-report-data");
    // build a type-specific summary for the dark box
    let lines = [];
    const winLine =
      (data?.window?.from || data?.window?.to)
        ? `Window ‚Äî from: ${data?.window?.from ?? "‚Äî"} to: ${data?.window?.to ?? "‚Äî"}`
        : "";

    // 1) Only Sales shows money KPIs
    if (type === "sales") {
      lines = [
        `Revenue:  ${peso(data?.revenue)}`,
        `Expenses: ${peso(data?.expenses)}`,
        `Profit:   ${peso(data?.profit)}`,
        winLine
      ];
    }

    // 2) Mortality: total cases + window
    else if (type === "mortality") {
      const total = Number(data?.total_mortalities || 0);
      lines = [
        `Total Mortalities: ${total.toLocaleString()}`,
        winLine
      ];
    }

    // 3) Feed Consumption: total kg + window
    else if (type === "feed_consumption") {
      const totalKg = Number(data?.total_kg || 0);
      lines = [
        `Total Quantity (kg): ${totalKg.toLocaleString()}`,
        winLine
      ];
    }

    // 4) Inventory: counts + (optional) low-stock
    else if (type === "inventory") {
      const items = Array.isArray(data?.items) ? data.items.length : 0;
      const low   = Array.isArray(data?.low_stock) ? data.low_stock.length : 0;
      lines = [
        `Items: ${items}`,
        `Low Stock: ${low}`
      ];
    }

    // Apply to <pre>
    pre.textContent = lines.filter(Boolean).join("\n");

    // If you still have DOM elements for money KPIs elsewhere in the modal (.js-rev/.js-exp/.js-profit),
    // clear them for non-sales reports so no stale values remain:
    document.querySelectorAll(".js-rev,.js-exp,.js-profit").forEach(el => (el.textContent = ""));
    if (type === "sales") {
      document.querySelectorAll(".js-rev").forEach(el => (el.textContent = peso(data?.revenue)));
      document.querySelectorAll(".js-exp").forEach(el => (el.textContent = peso(data?.expenses)));
      document.querySelectorAll(".js-profit").forEach(el => (el.textContent = peso(data?.profit)));
    }


    // üëâ draw chart for this report
    resetChart();
    if (type === "sales") {
      drawSalesChart(data);
    } else if (type === "mortality") {
      drawMortalityChart(data);
    } else if (type === "feed_consumption") {
      drawFeedChart(data);
    } else if (type === "inventory") {
      drawInventoryChart(data);
    }

    // Export / Print / PDF (keep as-is)
    document.getElementById("btn-export").onclick = () =>
      exportCSV({ type, ...data });
    document.getElementById("btn-print").onclick  = () => window.print();
    document.getElementById("btn-pdf").onclick    = () => window.print();

    modal.style.display = "block";
  }



  // ---------- Generate (POST /reports/generate) ----------
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    // Map UI to backend types: sales remains sales, inventory is inventory, etc.
    const typeMap = {
      sales: "sales",
      profit_loss: "sales",            // merged into "sales"
      mortality: "mortality",
      feed_consumption: "feed_consumption",
      inventory: "inventory"
    };

    const selected = selType.value;                       // "sales" | "profit_loss" | ...
    const report_type = typeMap[selected] || "sales";
    const date_from   = inpFrom.value || null;            // YYYY-MM-DD (inclusive)
    const date_to     = inpTo.value   || null;            // YYYY-MM-DD (inclusive)

    const payload = {
      report_type,
      filters: {
        ...(date_from ? { date_from } : {}),
        ...(date_to   ? { date_to }   : {}),
        // no low_stock_threshold
      },
      snapshot: true
    };

    // Generate (server stores it). Then refresh list and open the returned full report.
    const generated = await reportsApi.generate(payload);
    // If the endpoint returns just the object or an id, handle both:
    let full = generated;
    if (!generated?.type && generated?.id) {
      full = await reportsApi.get(generated.id);
    }
    openReportModal(full);
    await loadAndRenderLists();
  });
  
  // ---------- Init ----------
  await loadAndRenderLists();

  document.getElementById("logoutLink")?.addEventListener("click", (e) => {
  e.preventDefault();
  try {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("token");
    localStorage.removeItem("access_token");
  } catch {}
  window.location.href = "/Zhomepage/login.html";
});

</script>

</body>
</html>
