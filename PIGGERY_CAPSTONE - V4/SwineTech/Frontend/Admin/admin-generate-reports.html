<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Reports</title>
  <link rel="stylesheet" href="/Admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== Base layout ===== */
    main.dashboard{flex:1;padding:24px;box-sizing:border-box;overflow:auto}

    /* ===== Pig-Records button palette ===== */
    .btn{padding:7px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600}
    .btn-primary{background:#e8f5ff;color:#0b6bcb;border-color:#cde8ff}
    .btn-muted{background:#f8fafb;color:#374151;border:1px solid #e5e7eb}
    .btn-danger{background:#ffe5e5;color:#b42318;border-color:#ffc9c9}

    /* Generate button */
    .btn-generate{all:unset}
    .btn-generate{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;
      background:#1a7f37;color:#fff;cursor:pointer;font-weight:700}
    .btn-generate:hover{background:#15652c}

    /* ===== Pills/Tabs ===== */
    .tabs{display:flex;gap:8px;margin:12px 0 16px}
    .tabs .btn{background:#eef5ee;color:#2E7D32;border:1px solid #d7e8db}
    .tabs .btn.active{background:#2E7D32;color:#fff;border-color:#2E7D32}

    /* ===== Carded table wrapper ===== */
    .table-wrap{background:#fff;border-radius:16px;border:1px solid #eef2f6;
      box-shadow:0 10px 24px rgba(16,24,40,.06);overflow:hidden;margin-top:12px}

    /* ===== Modern table ===== */
    .admin-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    .admin-table thead th{
      position:sticky;top:0;z-index:1;background:#f8fafb;color:#374151;font-weight:700;
      padding:12px 14px;border-bottom:1px solid #e6ebf0;text-align:left;letter-spacing:.02em
    }
    .admin-table tbody td{padding:12px 14px;border-bottom:1px solid #eef2f6;color:#1f2937}
    .admin-table tbody tr:nth-child(even) td{background:#fbfdfe}
    .admin-table tbody tr:hover td{background:#f3f7fb}
    .admin-table td .btn{margin-right:6px}

    /* ===== Filter form ===== */
    .report-filter{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:#fff;padding:12px 14px;
      border:1px solid #eef2f6;border-radius:14px;box-shadow:0 8px 20px rgba(16,24,40,.06);margin:10px 0
    }
    .report-filter label{font-weight:600;color:#374151}
    .report-filter select,.report-filter input{
      padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none
    }
    .report-filter select:focus,.report-filter input:focus{
      border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)
    }

    /* ===== Modal ===== */
    .modal{
      display:none;
      position:fixed; inset:0; z-index:50;
      background:rgba(17,24,39,.55);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .modal-content{
      width:min(900px,92vw);
      max-height:90vh;
      overflow:auto;                 /* scroll inside modal, not page */
      background:#fff; border:1px solid #eef2f6;
      border-radius:16px; box-shadow:0 20px 40px rgba(16,24,40,.25);
      padding:20px 22px;

      /* key: give children breathing room so blocks don't collide */
      display:flex; flex-direction:column; gap:12px;
    }
    .close{position:sticky; top:0; align-self:flex-end; font-size:22px; cursor:pointer; color:#6b7280}
    .close:hover{color:#ef4444}

  
    .chart-box{
      position:relative;
      height:300px;              /* reserve space */
      margin:6px 0 14px;         /* add bottom gap before "Report Content" */
      overflow:visible;          /* was hidden ‚Üí caused clipping */
    }
    #report-chart{display:block; width:100% !important; height:100% !important}


    /* Toolbar spacing (if present) */
    #chart-toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0}

    /* Report content spacing */
    .report-data h3{margin:0 0 8px}
    .report-data pre{margin:0}
    @media (max-width:480px){ .chart-box{height:230px} .modal{padding:12px} }
    /* optional: nicer mobile spacing */
    @media (max-width:480px){
      .modal{padding:12px}
      .chart-box{height:220px}
    }

    /* ===== Responsive: collapse tables on mobile ===== */
    @media (max-width:880px){
      .admin-table thead{display:none}
      .admin-table,.admin-table tbody,.admin-table tr,.admin-table td{display:block;width:100%}
      .admin-table tr{background:#fff;border:1px solid #eef2f6;border-radius:12px;margin:10px 0;padding:10px}
      .admin-table td{border:0;padding:8px 4px}
      .admin-table td::before{
        content:attr(data-label);display:block;font-size:12px;color:#6b7280;margin-bottom:2px;text-transform:uppercase
      }
      .table-wrap{box-shadow:none;border:0;background:transparent}
    }
    /* ---------- Pig Records theme overrides for Reports ---------- */
    .tabs{display:flex;gap:8px;margin:12px 0 16px}
    .tabs .btn{
      background:#f3f4f6; color:#374151; border:1px solid #e5e7eb;
      padding:10px 14px; border-radius:10px; font-weight:600;
    }
    .tabs .btn.active{background:#1a7f37;color:#fff;border-color:#1a7f37}

    .btn-generate{
      all:unset;
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 14px;border-radius:10px;
      background:#e8f5ff;color:#0b6bcb;border:1px solid #cde8ff;
      cursor:pointer;font-weight:700;
    }
    .btn-generate:hover{filter:brightness(.98)}

    .report-filter{
      margin:10px 0 8px;
      border-radius:16px; border:1px solid #eef2f6;
      box-shadow:0 10px 24px rgba(16,24,40,.06);
    }

    .table-wrap{
      background:#fff;border-radius:16px;border:1px solid #eef2f6;
      box-shadow:0 10px 24px rgba(16,24,40,.06);overflow:hidden;margin-top:12px
    }
    .admin-table thead th{
      background:#f8fafb;color:#374151;
      padding:12px 14px;border-bottom:1px solid #e6ebf0;text-align:left
    }
    .admin-table tbody td{padding:12px 14px;border-bottom:1px solid #eef2f6;color:#1f2937}
    .admin-table tbody tr:nth-child(even) td{background:#fbfdfe}
    .admin-table tbody tr:hover td{background:#f3f7fb}

    .btn-primary{background:#e8f5ff;color:#0b6bcb;border:1px solid #cde8ff;border-radius:10px}
    .btn-danger {background:#ffe5e5;color:#b42318;border:1px solid #ffc9c9;border-radius:10px}
    .btn-muted  {background:#f8fafb;color:#374151;border:1px solid #e5e7eb;border-radius:10px}
    /* === Reports: action pills (match other pages) === */
    .btn-view{
      background:#4aa3ff;           /* same blue pill */
      color:#fff;
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-weight:700;
    }
    .btn-archive-soft{
      background:#E76161;            /* same light red pill */
      color:#fff;
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-weight:700;
    }



  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-admin.html"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</a>
      <a href="admin-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="admin-manage-user-accounts.html"><i class="fa-solid fa-users"></i> Manage User Accounts</a>
      <a href="admin-manage-pig-records.html"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="admin-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedule</a>
      <a href="admin-manage-supplies.html"><i class="fa-solid fa-boxes-stacked"></i> Manage Supplies</a>
      <a href="admin-manage-sales-expenses-bookings.html"><i class="fa-solid fa-money-bill-trend-up"></i> Manage Sales, Expenses & Bookings</a>
      <a href="admin-manage-client-feedback-admin.html"><i class="fa-solid fa-comment-dots"></i> Manage Client Feedback</a>
      <a href="admin-generate-reports.html" class="active"><i class="fa-solid fa-file-lines"></i> Generate Reports</a>
      <a href="#" id="logoutLink" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard">
    <h1>Reports</h1>
    <p class="page-desc">Generate and view system reports such as Sales, Mortality, Feed Consumption, and Inventory.</p>

    <!-- Generate Report Form -->
    <form id="report-form" class="report-filter">
      <label for="report-type">Report Type:</label>
      <select id="report-type" name="report-type" required>
        <option value="sales">Sales</option>
        <option value="mortality">Mortality</option>
        <option value="feed_consumption">Feed Consumption</option>
        <option value="inventory">Inventory Usage</option>
      </select>

      <label for="date-from">From:</label>
      <input type="date" id="date-from" name="date-from">

      <label for="date-to">To:</label>
      <input type="date" id="date-to" name="date-to">

      <button type="submit" class="btn-generate"><i class="fa-solid fa-filter"></i> Generate Report</button>
    </form>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tab-reports"  class="btn active">Reports</button>
      <button id="tab-archived" class="btn">Archived</button>
    </div>

    <!-- Reports list -->
    <div id="section-reports">
      <h2><i class="fa-solid fa-clock-rotate-left"></i> Previously Generated Reports</h2>
      <div class="table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Report ID</th><th>Type</th><th>Generated By</th><th>Date Generated</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Archived list -->
    <div id="section-archived" style="display:none">
      <h2><i class="fa-solid fa-box-archive"></i> Archived Reports</h2>
      <div class="table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Report ID</th><th>Type</th><th>Generated By</th><th>Date Generated</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="archive-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal" style="display:none">
      <div class="modal-content">
        <span class="close" id="modal-close">&times;</span>
        <h2>Report Details</h2>
        <p><strong>Report Type:</strong> <span id="modal-report-type">‚Äî</span></p>
        <p><strong>Generated At:</strong> <span id="modal-generated-at">‚Äî</span></p>
        <p><strong>Generated By:</strong> <span id="modal-generated-by">‚Äî</span></p>

        <div class="chart-box" style="margin:12px 0">
          <canvas id="report-chart"></canvas>
        </div>

        <div class="report-data">
          <h3>Report Content</h3>
          <pre id="modal-report-data">Report details will appear here...</pre>
        </div>

        <div class="report-actions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btn-export"><i class="fa-solid fa-file-excel"></i> Export CSV</button>
          <button class="btn btn-danger"  id="btn-pdf"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
          <button class="btn btn-muted"   id="btn-print"><i class="fa-solid fa-print"></i> Print</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Logic -->
  <script type="module">
  import { authApi, reportsApi } from "../_shared/api.js";

  const API_BASE = "http://localhost:8000/api";

  function authHeaders(extra = {}) {
  const token =
    localStorage.getItem("auth_token") ||
    localStorage.getItem("token") ||
    localStorage.getItem("access_token");

  return {
    Accept: "application/json",
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
    ...extra,
  };
}


  // ---------- Auth (no role gates; just who am I for "Generated By") ----------
  let me = { username: "admin" };
  try { me = await authApi.me(); } catch {}


    // ===== Mortality & Inventory helpers =====

// Simple concurrency limiter for /pigs/{id}/meta fan-out
async function mapLimit(arr, limit, iteratee) {
  const ret = [];
  let i = 0, active = 0;
  return new Promise((resolve, reject) => {
    const next = () => {
      if (i >= arr.length && active === 0) return resolve(ret);
      while (active < limit && i < arr.length) {
        const idx = i++, val = arr[idx];
        active++;
        Promise.resolve(iteratee(val, idx))
          .then((r) => { ret[idx] = r; active--; next(); })
          .catch(reject);
      }
    };
    next();
  });
}

async function saveCustomReport({ report_type, data }) {
  const payload = { report_type, data, snapshot: true };

  // Try: POST /api/reports  (saves our client-built "data" as-is)
  let r = await fetch(`${API_BASE}/reports`, {
    method: "POST",
    headers: authHeaders({ "Content-Type": "application/json" }),
    body: JSON.stringify(payload),
  });

  // If that route isn't available, fall back to POST /api/reports/generate
  // (Backend recomputes; we pass client_data for debugging/forward-compat.)
  if (r.status === 404 || r.status === 405) {
    r = await fetch(`${API_BASE}/reports/generate`, {
      method: "POST",
      headers: authHeaders({ "Content-Type": "application/json" }),
      body: JSON.stringify({
        report_type,
        filters: {},          // you can pass date_from/date_to if you want
        snapshot: true,
        client_data: data,    // harmless extra field if server ignores it
      }),
    });
  }

  if (!r.ok) {
    const msg = await r.text().catch(() => "");
    throw new Error(`Save failed: ${r.status} ${msg}`);
  }
  return r.json();
}



// UTC formatters + groupers
const toUTCDate = (iso) => {
  const d = new Date(iso);
  return Number.isNaN(d) ? null : d;
};
const dayKeyUTC   = (iso) => {
  const d = toUTCDate(iso); if (!d) return null;
  return d.toISOString().slice(0, 10); // YYYY-MM-DD
};
const monthKeyUTC = (iso) => {
  const d = toUTCDate(iso); if (!d) return null;
  return d.toISOString().slice(0, 7);  // YYYY-MM
};

// Threshold rule by category
function invThreshold(cat) {
  return String(cat).toLowerCase() === "feed" ? 10 : 3;
}




  // ---------- DOM ----------
  const form          = document.getElementById("report-form");
  const selType       = document.getElementById("report-type");
  const inpFrom       = document.getElementById("date-from");
  const inpTo         = document.getElementById("date-to");

  const historyTbody  = document.getElementById("history-tbody");
  const archivedTbody = document.getElementById("archive-tbody");

  // Modal
  const modal         = document.getElementById("reportModal");
  const modalClose    = document.getElementById("modal-close");
  const mType         = document.getElementById("modal-report-type");
  const mGenAt        = document.getElementById("modal-generated-at");
  const mGenBy        = document.getElementById("modal-generated-by");
  const mPre          = document.getElementById("modal-report-data"); // still used for CSV/Debug

  const btnExport     = document.getElementById("btn-export");
  const btnPrint      = document.getElementById("btn-print");
  const btnPdf        = document.getElementById("btn-pdf");

  // ========== CHARTS ==========
let chart;                                // single chart instance
const chartCanvas = document.getElementById("report-chart");

function resetChart() {                   // destroy if we re-open the modal
  if (chart) { chart.destroy(); chart = null; }
}
function ensureChartCtx() {               // safe ctx getter
  return chartCanvas.getContext("2d");
}

// Sales ‚Äî stacked bar of Revenue / Expenses + Profit line (from by_month)
function drawSalesChart(data) {
  const rows = Array.isArray(data.by_month) ? data.by_month : [];
  const labels   = rows.map(r => r.month);
  const revenue  = rows.map(r => Number(r.revenue  ?? 0));
  const expenses = rows.map(r => Number(r.expenses ?? 0));
  const profit   = rows.map((r,i) => Number(r.profit ?? (revenue[i]-expenses[i])));

  resetChart();
  hideChartToolbar();

  // Fallback single summary
  if (!labels.length) {
    chart = new Chart(ensureChartCtx(), {
      type: "bar",
      data: {
        labels: ["Revenue","Expenses","Profit"],
        datasets: [{ label: "Amount", data: [
          Number(data.revenue ?? 0),
          Number(data.expenses ?? 0),
          Number(data.profit ?? (Number(data.revenue ?? 0)-Number(data.expenses ?? 0))),
        ]}]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{
          label: ctx => `${ctx.dataset.label}: ${fmtPesoCompact(ctx.parsed.y)}`
        }}},
        scales:{ y:{ ticks:{ callback:v => fmtPesoCompact(v) } } }
      }
    });
    return;
  }

  chart = new Chart(ensureChartCtx(), {
    data: {
      labels,
      datasets: [
        { type:"bar",  label:"Revenue",  data: revenue,  yAxisID:"y", barPercentage:.5, categoryPercentage:.7 },
        { type:"bar",  label:"Expenses", data: expenses, yAxisID:"y", barPercentage:.5, categoryPercentage:.7 },
        { type:"line", label:"Profit",   data: profit,   yAxisID:"y1", tension:.3, pointRadius:3, fill:false }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ bottom: 16 } },
      plugins:{
        legend:{ position:"top" },
        tooltip:{ callbacks:{
          label: ctx => {
            const v = ctx.parsed.y;
            if (ctx.dataset.type === "line") return `Profit: ${fmtPesoCompact(v)}`;
            return `${ctx.dataset.label}: ${fmtPesoCompact(v)}`;
          }
        }}
      },
      scales:{
        x:{ stacked:false },
        y :{ stacked:false, ticks:{ callback:v => fmtPesoCompact(v) } },
        y1:{ position:"right", grid:{ drawOnChartArea:false }, ticks:{ callback:v => fmtPesoCompact(v) } }
      }
    }
  });
}


function drawMortalityChart(data) {
  resetChart();
  hideChartToolbar();
  const toolbar = ensureChartToolbar();

  // If legacy "by_cause" exists, add a 3rd toggle; otherwise just Day/Month
  const hasByCause = Array.isArray(data.by_cause) && data.by_cause.length;

  const btnDay    = Object.assign(document.createElement("button"), { className:"btn btn-primary", textContent:"By Day" });
  const btnMonth  = Object.assign(document.createElement("button"), { className:"btn btn-muted",   textContent:"Trend (Monthly)" });
  toolbar.append(btnDay, btnMonth);

  let btnCause;
  if (hasByCause) {
    btnCause = Object.assign(document.createElement("button"), { className:"btn btn-muted", textContent:"By Diagnosis" });
    toolbar.append(btnCause);
  }

  const renderDay = () => {
    const rows = Array.isArray(data.by_day) ? data.by_day : [];
    const labels = rows.map(r => r.day);
    const values = rows.map(r => Number(r.cases || 0));
    const total  = values.reduce((a,b)=>a+b,0);

    if (chart) chart.destroy();
    chart = new Chart(ensureChartCtx(), {
      type: "bar",
      data: { labels, datasets: [{ label:"Cases", data: values }] },
      options: {
        indexAxis:"y",
        responsive:true, maintainAspectRatio:false,
        layout:{ padding:{ bottom: 16 } },
        plugins:{
          legend:{ position:"top" },
          tooltip:{ callbacks:{ label: ctx => {
            const v = ctx.parsed.x || 0; const pct = total ? ((v/total)*100).toFixed(1) : "0.0";
            return `Cases: ${v} (${pct}%)`;
          }}}
        },
        scales:{ x:{ ticks:{ precision:0 } }, y:{ ticks:{ autoSkip:false } } }
      }
    });

    btnDay.className="btn btn-primary";
    btnMonth.className="btn btn-muted";
    if (btnCause) btnCause.className="btn btn-muted";
  };

  const renderMonth = () => {
    const rows = Array.isArray(data.by_month) ? data.by_month : [];
    const labels = rows.map(r => r.month);
    const values = rows.map(r => Number(r.cases || 0));
    if (chart) chart.destroy();
    chart = new Chart(ensureChartCtx(), {
      type:"line",
      data:{ labels, datasets:[{ label:"Cases", data: values, tension:.3, pointRadius:3, fill:false }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        layout:{ padding:{ bottom: 16 } },
        plugins:{ legend:{ position:"top" } },
        scales:{ y:{ ticks:{ precision:0 } } }
      }
    });

    btnDay.className="btn btn-muted";
    btnMonth.className="btn btn-primary";
    if (btnCause) btnCause.className="btn btn-muted";
  };

  const renderCause = () => {
    const rows = Array.isArray(data.by_cause) ? data.by_cause : [];
    const labels = rows.map(r => r.diagnosis || "Unknown");
    const values = rows.map(r => Number(r.cases || 0));
    const total  = values.reduce((a,b)=>a+b,0);

    if (chart) chart.destroy();
    chart = new Chart(ensureChartCtx(), {
      type: "bar",
      data: { labels, datasets: [{ label:"Cases", data: values }] },
      options: {
        indexAxis:"y",
        responsive:true, maintainAspectRatio:false,
        layout:{ padding:{ bottom: 16 } },
        plugins:{
          legend:{ position:"top" },
          tooltip:{ callbacks:{ label: ctx => {
            const v = ctx.parsed.x || 0; const pct = total ? ((v/total)*100).toFixed(1) : "0.0";
            return `Cases: ${v} (${pct}%)`;
          }}}
        },
        scales:{ x:{ ticks:{ precision:0 } }, y:{ ticks:{ autoSkip:false } } }
      }
    });

    btnDay.className="btn btn-muted";
    btnMonth.className="btn btn-muted";
    if (btnCause) btnCause.className="btn btn-primary";
  };

  // default
  renderDay();
  btnDay.onclick   = renderDay;
  btnMonth.onclick = renderMonth;
  if (btnCause) btnCause.onclick = renderCause;
}


// Feed Consumption ‚Äî bar by feed type (kg)
function drawFeedChart(data) {
  resetChart();
  hideChartToolbar();
  const rows = Array.isArray(data.by_feed_type) ? data.by_feed_type : [];
  const labels = rows.map(r => r.feed_type || "Unknown");
  const values = rows.map(r => Number(r.kg || 0));
  const total  = sum(values);

  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: { labels, datasets: [{ label:"Kg", data: values }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ bottom: 16 } },  
      plugins:{
        legend:{ position:"top" },
        tooltip:{ callbacks:{
          label: ctx => {
            const v = Math.round(ctx.parsed.y || 0);          // no decimals
            const pct = total ? ((v/total)*100).toFixed(1) : "0.0";
            return `Kg: ${v} (${pct}%)`;
          }
        }}
      },
      scales:{
        y:{ ticks:{ precision:0 } } // integers only
      }
    }
  });
}


// Inventory ‚Äî top 10 quantities by item
function drawInventoryChart(data) {
  resetChart();
  hideChartToolbar();

  const items = Array.isArray(data.items) ? data.items : [];
  const lowSet = new Set((data.low_stock || []).map(it => (it.item_name || it.name || "").toLowerCase()));
  const threshold = Number(data.low_stock_threshold ?? 0);

  // keep metadata we need in tooltips (category + unit)
  const top = items
    .map(it => ({
      name: it.item_name || it.name,
      qty: Number(it.quantity || 0),
      category: it.category || "other",
      unit: it.unit || ""
    }))
    .sort((a, b) => b.qty - a.qty)
    .slice(0, 10);

  const labels = top.map(x => x.name);
  const values = top.map(x => x.qty);
  const metaByIndex = top.map(x => ({ category: x.category, unit: x.unit }));

  const colors = top.map(x => {
    const isLow = lowSet.has((x.name || "").toLowerCase()) || (threshold > 0 && x.qty <= threshold);
    return isLow ? "#ef4444" : "#60a5fa";
  });

  chart = new Chart(ensureChartCtx(), {
    type: "bar",
    data: { labels, datasets: [{ label: "Quantity", data: values, backgroundColor: colors }] },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { bottom: 16 } },
      plugins: {
        legend: { position: "top" },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.x || 0;
              const meta = metaByIndex[ctx.dataIndex] || { category: "", unit: "" };
              const isLow = colors[ctx.dataIndex] === "#ef4444";
              // e.g. "Qty: 144 kg ‚Äî Feed  (LOW)"
              const unit = meta.unit ? ` ${meta.unit}` : "";
              const cat  = meta.category ? ` ‚Äî ${meta.category}` : "";
              return `Qty: ${v}${unit}${cat}${isLow ? "  (LOW)" : ""}`;
            }
          }
        }
      },
      scales: { x: { ticks: { precision: 0 } }, y: { ticks: { autoSkip: false } } }
    }
  });
}


function drawInventoryByCategoryChart(data) {
  resetChart();
  hideChartToolbar();
  const rows = Array.isArray(data.by_category) ? data.by_category : [];
  const labels = rows.map(r => r.category || "other");
  const values = rows.map(r => Number(r.total_quantity || 0));

  chart = new Chart(ensureChartCtx(), {
    type:"bar",
    data:{ labels, datasets:[{ label:"Quantity", data: values }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ bottom: 16 } },
      plugins:{ legend:{ position:"top" } },
      scales:{ y:{ ticks:{ precision:0 } } }
    }
  });
}


  // --- Tabs (Reports / Archived) ---
  const tabReports      = document.getElementById("tab-reports");
  const tabArchived     = document.getElementById("tab-archived");
  const sectionReports  = document.getElementById("section-reports");
  const sectionArchived = document.getElementById("section-archived");

  function activate(which){
    const isReports = which === "reports";
    sectionReports.style.display  = isReports ? "" : "none";
    sectionArchived.style.display = isReports ? "none" : "";

    tabReports.classList.toggle("active",  isReports);
    tabArchived.classList.toggle("active", !isReports);
  }

  tabReports.addEventListener("click",  () => activate("reports"));
  tabArchived.addEventListener("click", () => activate("archived"));

  // default
  activate("reports");




  // ---------- Archive (frontend-only) ----------
  const ARCHIVE_KEY = "archived_report_ids";
  const getArchived = () => {
    try { return new Set(JSON.parse(localStorage.getItem(ARCHIVE_KEY) || "[]")); }
    catch { return new Set(); }
  };
  const setArchived = (set) => {
    localStorage.setItem(ARCHIVE_KEY, JSON.stringify([...set]));
  };

  // ---------- Helpers ----------
  const peso = (n) =>
    "‚Ç±" + (Number(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const asLocalDateTime = (v) => {
    if (!v) return "";
    const d = new Date(v);
    const pad = (x) => (x < 10 ? "0" : "") + x;
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };

  const prettyType = (t) => ({
    sales: "Sales (Revenue, Expenses & Profit)",
    mortality: "Mortality",
    feed_consumption: "Feed Consumption",
    inventory: "Inventory",
  })[t] || t;

  // ===== LIVE Mortality (from /api/pigs + /api/pigs/{id}/meta) =====
// ===== LIVE Mortality (from /api/pigs + /api/pigs/{id}/meta) =====
async function fetchMortalityLive({ date_from=null, date_to=null } = {}) {
  // 1) load pigs with auth
  const pigsRes = await fetch(`${API_BASE}/pigs`, { headers: authHeaders() });
  if (!pigsRes.ok) throw new Error("Failed to load pigs");
  const pigs = await pigsRes.json();

  // robust "is deceased"
  const isDeceased = (p) => {
    const s = String(p.status ?? "").trim().toLowerCase();
    return (
      s === "deceased" ||
      s === "dead" ||
      p.is_deceased === true ||
      p.deceased === true ||
      p.deceased === 1
    );
  };

  // 2) filter deceased pigs
  const deceased = pigs.filter(isDeceased);

  // 3) fetch audit/meta.updated_at per deceased pig (correct URL + auth)
  const metas = await mapLimit(deceased, 8, async (p) => {
    const url = `${API_BASE}/api/pigs/${p.id}/meta`;   // <- no /api/api
    try {
      const r = await fetch(url, { headers: authHeaders() });
      if (!r.ok) {
        // fallback: use pig.updated_at if meta fails
        return { pig_id: p.id, death_at: p.updated_at || null };
      }
      const meta = await r.json();
      // prefer audit.updated_at; otherwise pig.updated_at
      return { pig_id: p.id, death_at: meta?.updated_at || p.updated_at || null };
    } catch {
      return { pig_id: p.id, death_at: p.updated_at || null };
    }
  });

  // 4) build deaths list (allow null dates initially)
  let deaths = metas.filter(m => m.death_at);

  // If all death_at are missing, still count the deceased pigs and
  // synthesize a timestamp (so totals/charts aren‚Äôt empty).
  if (deaths.length === 0 && deceased.length > 0) {
    const nowIso = new Date().toISOString();
    deaths = deceased.map(p => ({ pig_id: p.id, death_at: p.updated_at || nowIso }));
  }

  // 5) inclusive UTC window filtering (only if dates provided)
  if (date_from) deaths = deaths.filter(d => dayKeyUTC(d.death_at) >= date_from);
  if (date_to)   deaths = deaths.filter(d => dayKeyUTC(d.death_at) <= date_to);

  // 6) aggregates
  const dayMap = new Map();
  const monthMap = new Map();
  deaths.forEach(d => {
    const dk = dayKeyUTC(d.death_at);
    const mk = monthKeyUTC(d.death_at);
    if (dk) dayMap.set(dk, (dayMap.get(dk) || 0) + 1);
    if (mk) monthMap.set(mk, (monthMap.get(mk) || 0) + 1);
  });

  const by_day = [...dayMap.entries()]
    .sort((a,b)=> a[0].localeCompare(b[0]))
    .map(([day, cases]) => ({ day, cases }));

  const by_month = [...monthMap.entries()]
    .sort((a,b)=> a[0].localeCompare(b[0]))
    .map(([month, cases]) => ({ month, cases }));

  return {
    type: "mortality",
    total_mortalities: deaths.length,
    deaths,
    by_day,
    by_month,
    window: { from: date_from || null, to: date_to || null },
  };
}


// ===== LIVE Inventory (from /api/supplies) =====
async function fetchInventoryLive() {
  const res = await fetch(`${API_BASE}/supplies`, { headers:{ Accept:"application/json" }});
  if (!res.ok) throw new Error("Failed to load supplies");
  const items = await res.json();

  const enriched = items.map(it => ({
    item_name: it.item_name,
    category:  it.category,
    quantity:  Number(it.quantity || 0),
    unit:      it.unit || "",
    updated_at: it.updated_at || null
  }));

  // low stock list
  const low_stock = enriched.filter(it => it.quantity <= invThreshold(it.category));

  // by-category totals
  const catMap = new Map();
  enriched.forEach(it => {
    const key = String(it.category||"other").toLowerCase();
    catMap.set(key, (catMap.get(key)||0) + it.quantity);
  });
  const by_category = [...catMap.entries()].map(([category, total_quantity]) => ({ category, total_quantity }));

  return {
    type: "inventory",
    items: enriched,
    low_stock,
    low_stock_thresholds: { feed: 10, default: 3 },
    by_category,                         // for the new chart
  };
}


  // ----- Compact formatters -----
const fmtCompact = (n) =>
  (Number(n) || 0).toLocaleString(undefined, { notation: "compact", maximumFractionDigits: 1 });

const fmtPesoCompact = (n) => `‚Ç±${fmtCompact(n)}`;

// Sum helper
const sum = (arr) => arr.reduce((a,b)=>a+(Number(b)||0), 0);

// Add a small chart toolbar (for mortality view toggle)
function ensureChartToolbar() {
  let bar = document.getElementById("chart-toolbar");
  if (!bar) {
    bar = document.createElement("div");
    bar.id = "chart-toolbar";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.margin = "6px 0 6px";
    chartCanvas.parentElement.insertBefore(bar, chartCanvas);
  }
  bar.innerHTML = ""; // reset
  return bar;
}
function hideChartToolbar() {
  const bar = document.getElementById("chart-toolbar");
  if (bar) bar.remove();  // remove lingering toolbar completely
}


  // ---------- CSV (flatten major arrays) ----------
  function exportCSV(report) {
    const rows = [];
    const pushHeader = (cols) => { if (!rows.length) rows.push(cols.join(",")); };
    const esc = (v) => {
      if (v == null) return "";
      const s = typeof v === "object" ? JSON.stringify(v) : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };

    if (report?.type === "sales" && Array.isArray(report.by_month) && report.by_month.length) {
      pushHeader(Object.keys(report.by_month[0]));
      report.by_month.forEach(r => rows.push(Object.values(r).map(esc).join(",")));
    }
    else if (report?.type === "mortality") {
      if (Array.isArray(report.by_day) && report.by_day.length) {
        pushHeader(["day","cases"]);
        report.by_day.forEach(r => rows.push([r.day, r.cases].map(esc).join(",")));
      } else if (Array.isArray(report.by_month) && report.by_month.length) {
        pushHeader(["month","cases"]);
        report.by_month.forEach(r => rows.push([r.month, r.cases].map(esc).join(",")));
      } else if (Array.isArray(report.deaths) && report.deaths.length) {
        pushHeader(["pig_id","death_at_utc"]);
        report.deaths.forEach(d => rows.push([d.pig_id, d.death_at].map(esc).join(",")));
      } else {
        pushHeader(["total_mortalities"]);
        rows.push([esc(report.total_mortalities || 0)]);
      }
    }
    else if (report?.type === "feed_consumption" && Array.isArray(report.by_feed_type) && report.by_feed_type.length) {
      pushHeader(Object.keys(report.by_feed_type[0]));
      report.by_feed_type.forEach(r => rows.push(Object.values(r).map(esc).join(",")));
    }
    else if (report?.type === "inventory") {
      if (Array.isArray(report.items) && report.items.length) {
        pushHeader(["item_name","category","quantity","unit","updated_at"]);
        report.items.forEach(it => rows.push([it.item_name, it.category, it.quantity, it.unit, it.updated_at].map(esc).join(",")));
      } else {
        pushHeader(["category","total_quantity"]);
        (report.by_category||[]).forEach(r => rows.push([r.category, r.total_quantity].map(esc).join(",")));
      }
    }
    else {
      // Fallback
      const obj = report || {};
      const cols = Object.keys(obj);
      pushHeader(cols);
      rows.push(cols.map(k => esc(obj[k])).join(","));
    }

    const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `report_${(report?.type || "data")}_${Date.now()}.csv`;
    a.click();
  }

  const csvEscape = (v) => {
    if (v == null) return "";
    const s = typeof v === "object" ? JSON.stringify(v) : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };

  modalClose.addEventListener("click", () => {
    resetChart();
    hideChartToolbar();
    modal.style.display = "none";
    document.body.style.overflow = "";
  });

  window.addEventListener("click", (e) => {
    if (e.target === modal) {
      resetChart();
      hideChartToolbar();
      modal.style.display = "none";
      document.body.style.overflow = "";
    }
  });


  btnPrint.onclick = () => window.print();
  btnPdf.onclick   = () => window.print(); // keep as print

  // ---------- List + Archive rendering ----------
  async function loadAndRenderLists() {
    const archived = getArchived();
    const list = await reportsApi.list(); // server-stored reports

    // Render visible (not archived)
    historyTbody.innerHTML = "";
    list.filter(r => !archived.has(r.id)).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${prettyType(r.type || r.report_type)}</td>
        <td>${r.generated_by || "admin"}</td>
        <td>${asLocalDateTime(r.generated_at)}</td>
        <td>
          <button class="btn-view">View</button>
          <button class="btn-archive-soft btn-archive">Archive</button>
        </td>


      `;
      tr.querySelector(".btn-view").onclick = async () => {
        const full = await reportsApi.get(r.id);
        openReportModal(full);
      };
      tr.querySelector(".btn-archive").onclick = () => {
        archived.add(r.id);
        setArchived(archived);
        loadAndRenderLists();
      };
      historyTbody.appendChild(tr);
    });

    // Render archived table
    archivedTbody.innerHTML = "";
    list.filter(r => archived.has(r.id)).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${prettyType(r.type || r.report_type)}</td>
        <td>${r.generated_by || "admin"}</td>
        <td>${asLocalDateTime(r.generated_at)}</td>
        <td><button class="btn btn-muted btn-restore">Restore</button></td>
      `;
      tr.querySelector(".btn-restore").onclick = () => {
        archived.delete(r.id);
        setArchived(archived);
        loadAndRenderLists();
      };
      archivedTbody.appendChild(tr);
    });
  }

// --- Normalise any row to { type, data, generated_at, generated_by }
  function normalizeReportRow(rowOrData) {
    // Server row shape: { id, report_type, generated_by, generated_at, data }
    // Old local shape  : { type, ... } or { payload: {...} }
    const data =
      rowOrData?.data ??
      rowOrData?.payload ??           // local history entry you saved earlier
      rowOrData?.a ??                 // safety for your screenshot showing "a"
      rowOrData;                      // allow direct report object

    const type =
      rowOrData?.report_type ??
      data?.type ??
      "sales";

    const generated_at =
      rowOrData?.generated_at ??
      new Date().toISOString();

    const generated_by =
      rowOrData?.generated_by ?? (window.me?.username || "admin");

    // sensible defaults; backend sometimes may omit
    const d = data || {};
    d.revenue   = Number(d.revenue   ?? 0);
    d.expenses  = Number(d.expenses  ?? 0);
    d.profit    = Number(d.profit    ?? 0);
    d.by_month  = Array.isArray(d.by_month) ? d.by_month : [];
    d.window    = d.window || { from: null, to: null };

    return { type, data: d, generated_at, generated_by };
  }

  function openReportModal(rowOrData) {
    const { type, data, generated_at, generated_by } = normalizeReportRow(rowOrData);


    // header fields
    document.getElementById("modal-report-type").textContent = prettyType(type);
    document.getElementById("modal-generated-at").textContent =
      new Date(generated_at).toLocaleString();
    document.getElementById("modal-generated-by").textContent = generated_by;

    // numbers & window
    const peso = (n) =>
      `‚Ç±${(Number(n) || 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

    // If you still have a "black window box" element before .report-data, update its fields
    const windowBox = document.querySelector(".report-data")?.previousElementSibling;
    if (windowBox && /window/i.test(windowBox.textContent || "")) {
      const fromEl = windowBox.querySelector ? windowBox.querySelector(".window-from") : null;
      const toEl   = windowBox.querySelector ? windowBox.querySelector(".window-to")   : null;
      if (fromEl) fromEl.textContent = data?.window?.from ?? "‚Äî";
      if (toEl)   toEl.textContent   = data?.window?.to   ?? "‚Äî";
    }

    // If you printed revenue/expenses/profit directly in the modal somewhere:
    document.querySelectorAll(".js-rev").forEach(el => (el.textContent = peso(data?.revenue)));
    document.querySelectorAll(".js-exp").forEach(el => (el.textContent = peso(data?.expenses)));
    document.querySelectorAll(".js-profit").forEach(el => (el.textContent = peso(data?.profit)));

    
    // Replace the <pre> content with a quick readable summary
    const pre = document.getElementById("modal-report-data");
    // build a type-specific summary for the dark box
    let lines = [];
    const winLine =
      (data?.window?.from || data?.window?.to)
        ? `Window ‚Äî from: ${data?.window?.from ?? "‚Äî"} to: ${data?.window?.to ?? "‚Äî"}`
        : "";

    // 1) Only Sales shows money KPIs
    if (type === "sales") {
      lines = [
        `Revenue:  ${peso(data?.revenue)}`,
        `Expenses: ${peso(data?.expenses)}`,
        `Profit:   ${peso(data?.profit)}`,
        winLine
      ];
    }

    // 2) Mortality: total cases + window
    else if (type === "mortality") {
      const total = Number(data?.total_mortalities || 0);
      lines = [
        `Total Mortalities: ${total.toLocaleString()}`,
        winLine
      ];
    }


    // 2) Mortality: total cases + window
    else if (type === "inventory") {
      // charts toggle (Top 10 / By Category)
      resetChart();
      hideChartToolbar();
      const toolbar = ensureChartToolbar();
      const btnTop = Object.assign(document.createElement("button"), { className:"btn btn-primary", textContent:"Top 10 Items" });
      const btnCat = Object.assign(document.createElement("button"), { className:"btn btn-muted",   textContent:"By Category" });
      toolbar.append(btnTop, btnCat);

      const renderTop = () => { drawInventoryChart(data); btnTop.className="btn btn-primary"; btnCat.className="btn btn-muted"; };
      const renderCat = () => { drawInventoryByCategoryChart(data); btnTop.className="btn btn-muted"; btnCat.className="btn btn-primary"; };
      renderTop();
      btnTop.onclick = renderTop;
      btnCat.onclick = renderCat;

      // summary lines for the <pre>
      const itemsArr = Array.isArray(data?.items) ? data.items : [];
      const items = itemsArr.length;
      const low   = Array.isArray(data?.low_stock) ? data.low_stock.length : 0;
      const categories = [...new Set(itemsArr.map(it => (it.category || "other").toLowerCase()))];
      const units      = [...new Set(itemsArr.map(it => (it.unit || "").toLowerCase()).filter(Boolean))];

      lines = [
        `Items: ${items}`,
        `Low Stock: ${low}`,
        `Categories: ${categories.join(", ") || "‚Äî"}`,
        `Quantity types: ${units.join(", ") || "‚Äî"}`
      ];
    }

    // Apply to <pre>
    pre.textContent = lines.filter(Boolean).join("\n");

    // If you still have DOM elements for money KPIs elsewhere in the modal (.js-rev/.js-exp/.js-profit),
    // clear them for non-sales reports so no stale values remain:
    document.querySelectorAll(".js-rev,.js-exp,.js-profit").forEach(el => (el.textContent = ""));
    if (type === "sales") {
      document.querySelectorAll(".js-rev").forEach(el => (el.textContent = peso(data?.revenue)));
      document.querySelectorAll(".js-exp").forEach(el => (el.textContent = peso(data?.expenses)));
      document.querySelectorAll(".js-profit").forEach(el => (el.textContent = peso(data?.profit)));
    }


    // üëâ draw chart for this report
    resetChart();
    if (type === "sales") {
      drawSalesChart(data);
    } else if (type === "mortality") {
      drawMortalityChart(data);
    } else if (type === "feed_consumption") {
      drawFeedChart(data);
    } else if (type === "inventory") {
      drawInventoryChart(data);
    }

    // Export / Print / PDF (keep as-is)
    document.getElementById("btn-export").onclick = () =>
      exportCSV({ type, ...data });
    document.getElementById("btn-print").onclick  = () => window.print();
    document.getElementById("btn-pdf").onclick    = () => window.print();

    modal.style.display = "flex";
    document.body.style.overflow = "hidden";  
    setTimeout(() => chart?.resize(), 0);

  }



  // ---------- Generate (POST /reports/generate) ----------
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const typeMap = {
      sales: "sales",
      profit_loss: "sales",             // merged
      mortality: "mortality",
      feed_consumption: "feed_consumption",
      inventory: "inventory",
    };
    const selected   = selType.value;
    const reportType = typeMap[selected] || "sales";
    const date_from  = inpFrom.value || null;
    const date_to    = inpTo.value   || null;

    try { 
    if (reportType === "mortality") {
      const data = await fetchMortalityLive({ date_from, date_to });

      // Show exactly what we computed on the client
      openReportModal({
        report_type: "mortality",
        data,
        generated_at: new Date().toISOString(),
        generated_by: me?.user_id || "admin",
      });

      // For now, skip saving so we don‚Äôt overwrite with the server‚Äôs zero result.
      try {
        await saveCustomReport({ report_type: "mortality", data });
        await loadAndRenderLists();
      } catch (err) {
        console.warn("Snapshot save failed:", err);
      }
      return;
    }



      // For server-computed reports (sales, feed_consumption), keep existing flow
      const payload = {
        report_type: reportType,
        filters: { ...(date_from ? { date_from } : {}), ...(date_to ? { date_to } : {}) },
        snapshot: true
      };
      const generated = await reportsApi.generate(payload);
      const full = !generated?.type && generated?.id ? await reportsApi.get(generated.id) : generated;
      openReportModal(full);
      await loadAndRenderLists();
    } catch (err) {
      console.error(err);
      alert(err?.message || "Failed to generate report");
    }
  });

  
  // ---------- Init ----------
  await loadAndRenderLists();

  document.getElementById("logoutLink")?.addEventListener("click", (e) => {
  e.preventDefault();
  try {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("token");
    localStorage.removeItem("access_token");
  } catch {}
  window.location.href = "/Zhomepage/login.html";
});

</script>

</body>
</html>
