<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SwineTech | Sales Staff ‚Äî Bookings</title>
  <link rel="stylesheet" href="/Sales-Staff/sales.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* Page-specific tweaks */
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 18px; }
    .toolbar .seg { display:flex; gap:8px; align-items:center; }
    .seg .badge { background:#eef3ef; color:#2e7d32; border-radius:999px; padding:2px 8px; font-size:.85rem; }
    .seg .badge.gray { background:#f1f1f1; color:#555; }
    .seg .badge.red  { background:#fdecec; color:#b3261e; }

    .filter-tabs { display:inline-flex; border:1px solid #ddd; border-radius:10px; overflow:hidden; }
    .filter-tabs button {
      background:#fafafa; border:none; padding:8px 12px; cursor:pointer; font-size:.95rem;
      border-right:1px solid #ddd;
    }
    .filter-tabs button:last-child { border-right:none; }
    .filter-tabs button.active { background:#2e7d32; color:#fff; }

    .quick-dates { display:inline-flex; gap:6px; }
    .quick-dates button {
      background:#f6f6f6; border:1px solid #e2e2e2; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.9rem;
    }
    .quick-dates button.active { background:#2e7d32; color:#fff; border-color:#2e7d32; }

    .list { margin-top: 10px; }
    .row {
      display:grid; grid-template-columns: 80px 130px 1fr 120px 130px 1fr 180px;
      gap:10px; align-items:center; padding:12px; border:1px solid #eee; border-radius:10px; background:#fff;
      margin-bottom:8px;
    }
    .row .dim { color:#666; font-size:.9rem; }
    .row .actions { display:flex; gap:8px; justify-content:flex-end; }

    .btn {
      border:none; cursor:pointer; border-radius:8px; padding:8px 12px; font-size:.9rem;
      display:inline-flex; gap:6px; align-items:center;
    }
    .btn-approve { background:#2e7d32; color:#fff; }
    .btn-decline { background:#b3261e; color:#fff; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10; }
    .modal .content {
      width:520px; max-width:95vw; background:#fff; margin:7% auto; border-radius:12px; padding:18px 18px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modal h2 { margin:0 0 12px; }
    .modal .line { margin:8px 0; }
    .modal .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
    .btn-close { background:#eee; color:#222; }
    .btn-primary { background:#2e7d32; color:#fff; }
    .btn-danger { background:#b3261e; color:#fff; }

    /* Empty state */
    .empty { text-align:center; color:#777; padding:18px 6px; }

    @media (max-width:1024px){
      .row { grid-template-columns: 70px 110px 1fr 110px 120px 1fr 160px; }
    }
    @media (max-width:820px){
      .row { grid-template-columns: 70px 1fr 1fr; grid-auto-rows:auto; }
      .row > div:nth-child(n+4):not(.actions){ font-size:.95rem; }
      .row .actions { grid-column: 1 / -1; justify-content:flex-start; }
    }
    /* Confirm for Approve/Decline ‚Äî stack above review modal */
    #confirmBookingModal { z-index: 40; }

  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech(Sales Staff)</div>
    <nav>
      <a href="dashboard-sales.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
      <a href="salesstaff-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="bookings-sales.html" class="active"><i class="fa-solid fa-calendar-check"></i> Bookings</a>
      <a href="sales-transactions.html"><i class="fa-solid fa-receipt"></i> Sales Transactions</a>
      <a href="reports-sales.html"><i class="fa-solid fa-file-lines"></i> Reports</a>
      <a href="#" id="logout" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="dashboard">
    <h1>Bookings (Sales Staff)</h1>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="seg">
        <strong>Status:</strong>
        <div class="filter-tabs" id="statusTabs">
          <button data-status="pending"  class="active">Pending <span class="badge" id="badgePending">0</span></button>
          <button data-status="approved">Approved <span class="badge gray" id="badgeApproved">0</span></button>
          <button data-status="declined">Declined <span class="badge red" id="badgeDeclined">0</span></button>
        </div>
      </div>
      <div class="seg">
        <strong>Date:</strong>
        <div class="quick-dates" id="dateTabs">
          <button data-range="all" class="active">All</button>
          <button data-range="today">Today</button>
          <button data-range="week">This week</button>
        </div>
      </div>
    </div>

    <!-- Header row -->
    <div class="row" style="background:#f8f9fa;border-color:#e8e8e8;">
      <div><strong>ID</strong></div>
      <div><strong>Client</strong></div>
      <div><strong>Type / Details</strong></div>
      <div><strong>Status</strong></div>
      <div><strong>Booked</strong></div>
      <div><strong>Pigs</strong></div>
      <div class="actions"><strong>Actions</strong></div>
    </div>

    <!-- List -->
    <section class="list" id="list"></section>
  </main>

  <!-- Review Modal -->
  <div class="modal" id="reviewModal">
    <div class="content">
      <h2><i class="fa-solid fa-clipboard-check"></i> Review Booking</h2>
      <div class="line" id="revSummary"></div>
      <div class="line dim" id="revClient"></div>
      <input type="hidden" id="revId"/>
      <div class="actions">
        <button class="btn btn-close" id="btnClose">Close</button>
        <button class="btn btn-danger" id="btnDecline"><i class="fa-solid fa-xmark"></i> Decline</button>
        <button class="btn btn-primary" id="btnApprove"><i class="fa-solid fa-circle-check"></i> Approve</button>
      </div>
    </div>
  </div>

  <!-- Approve/Decline Confirmation -->
<div class="modal" id="confirmBookingModal">
  <div class="content">
    <span id="confirmBookingClose" style="float:right;cursor:pointer;color:#6b7280">&times;</span>
    <h2 id="confirmBookingTitle" style="margin-top:0;">Confirm action</h2>

    <div id="confirmBookingSummary"
         style="white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin:10px 0;">
    </div>

    <p class="dim" id="confirmBookingWarn"
       style="background:#fff7ed;border:1px solid #ffedd5;border-radius:8px;padding:10px;">
      This will update the booking‚Äôs status.
    </p>

    <div class="actions">
      <button class="btn btn-primary" id="confirmBookingYes">Yes, proceed</button>
      <button class="btn btn-close"   id="confirmBookingNo">Cancel</button>
    </div>
  </div>
</div>


  <script type="module">
    /* ===================== Config ===================== */
    const API_BASE = "http://localhost:8000/api";
    const TOKEN = localStorage.getItem("token") || "";

    /* ===================== Helpers ===================== */
    const $ = (id) => document.getElementById(id);
    const listEl = $("list");
    const badges = {
      pending:  $("badgePending"),
      approved: $("badgeApproved"),
      declined: $("badgeDeclined"),
    };

    function fmtDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toISOString().slice(0,10);
    }
    function inToday(iso) {
      if (!iso) return false;
      const d = new Date(iso);
      const now = new Date();
      return d.getFullYear()===now.getFullYear() &&
             d.getMonth()===now.getMonth() &&
             d.getDate()===now.getDate();
    }
    function weekBounds(date=new Date()){
      const d = new Date(date);
      const day = d.getDay(); // 0 Sun..6 Sat
      const diffToMon = (day+6)%7; // Mon=0
      const monday = new Date(d); monday.setDate(d.getDate()-diffToMon); monday.setHours(0,0,0,0);
      const sunday = new Date(monday); sunday.setDate(monday.getDate()+6); sunday.setHours(23,59,59,999);
      return [monday, sunday];
    }
    function inThisWeek(iso){
      if (!iso) return false;
      const d = new Date(iso);
      const [start, end] = weekBounds(new Date());
      return d >= start && d <= end;
    }

    function pigsText(pigs) {
      if (Array.isArray(pigs) && pigs.length) return pigs.join(", ");
      return (pigs ?? "-");
    }

    function actionButtons(id, disabled=false) {
      return `
        <button class="btn btn-decline" data-act="decline" data-id="${id}" ${disabled?"disabled":""}>
          <i class="fa-solid fa-xmark"></i> Decline
        </button>
        <button class="btn btn-approve" data-act="approve" data-id="${id}" ${disabled?"disabled":""}>
          <i class="fa-solid fa-circle-check"></i> Approve
        </button>
      `;
    }

    function toast(msg){
      // minimal toast (non-blocking)
      const d = document.createElement("div");
      d.textContent = msg;
      d.style.position="fixed"; d.style.left="50%"; d.style.transform="translateX(-50%)";
      d.style.bottom="20px"; d.style.background="#2e7d32"; d.style.color="#fff";
      d.style.padding="10px 14px"; d.style.borderRadius="10px"; d.style.zIndex=99;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(),1400);
    }

    /* ===================== Confirm modal state/helpers ===================== */
const confirmModal        = document.getElementById('confirmBookingModal');
const confirmTitle        = document.getElementById('confirmBookingTitle');
const confirmSummary      = document.getElementById('confirmBookingSummary');
const confirmWarn         = document.getElementById('confirmBookingWarn');
const confirmYes          = document.getElementById('confirmBookingYes');
const confirmNo           = document.getElementById('confirmBookingNo');
const confirmClose        = document.getElementById('confirmBookingClose');

let _pendingDecision = null; // "approved" | "declined"
let _pendingBooking  = null; // { id, type, item_details/notes, client_id, booking_date, pigs_ids }

function openConfirm(action, booking){
  _pendingDecision = action;                      // "approved" | "declined"
  _pendingBooking  = booking;                     // minimal booking summary

  confirmTitle.textContent = action === 'approved'
    ? 'Approve booking?'
    : 'Decline booking?';

  confirmWarn.textContent = action === 'approved'
    ? 'This will mark the booking as approved.'
    : 'This will mark the booking as declined.';

  const lines = [
    `Booking_ID: ${booking.id ?? '‚Äî'}`,
    `Client:     ${booking.client_id ?? '‚Äî'}`,
    `Type:       ${booking.type ?? booking.booking_type ?? '‚Äî'}`,
    `Details:    ${(booking.item_details ?? booking.notes ?? '‚Äî')}`,
    `Booked:     ${fmtDate(booking.booking_date)}`,
    `Pigs:       ${Array.isArray(booking.pigs_ids) ? booking.pigs_ids.join(', ') : (booking.pigs_ids ?? '‚Äî')}`,
    `Current:    ${booking.status ?? 'pending'}`
  ];
  confirmSummary.textContent = lines.join('\n');

  confirmModal.style.display = 'block';
}
function closeConfirm(){
  confirmModal.style.display = 'none';
  _pendingDecision = null;
  _pendingBooking  = null;
}
confirmClose?.addEventListener('click', closeConfirm);
confirmNo?.addEventListener('click', closeConfirm);
window.addEventListener('click', (e)=>{ if(e.target === confirmModal) closeConfirm(); });

confirmYes?.addEventListener('click', async ()=>{
  if(!_pendingDecision || !_pendingBooking){ closeConfirm(); return; }
  try{
    await decide(_pendingBooking.id, _pendingDecision);
    closeConfirm();
    // close review modal too (if it was open)
    document.getElementById('reviewModal').style.display = 'none';
    await refreshAll();
    toast(`Booking ${_pendingDecision}.`);
  }catch(err){
    alert(err.message || err);
  }
});


    /* ===================== API ===================== */
    /* ===================== API ===================== */
    async function getBookings(status){
      const token = localStorage.getItem("token"); // read fresh each call
      const res = await fetch(`${API_BASE}/bookings?status=${encodeURIComponent(status)}`, {
        headers: {
          "Accept": "application/json",
          ...(token ? { "Authorization": `Bearer ${token}` } : {}),
        },
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function decide(id, decision){
      const token = localStorage.getItem("token");
      const res = await fetch(`${API_BASE}/bookings/${id}/decision`, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          ...(token ? { "Authorization": `Bearer ${token}` } : {}),
        },
        body: JSON.stringify({ decision })
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    /* ===================== State ===================== */
    let statusFilter = "pending";  // "pending" | "approved" | "declined"
    let dateFilter   = "all";      // "all" | "today" | "week"
    let cache = { pending:[], approved:[], declined:[] };

    function applyDateFilter(rows){
      if(dateFilter==="all") return rows;
      if(dateFilter==="today") return rows.filter(r => inToday(r.booking_date));
      if(dateFilter==="week") return rows.filter(r => inThisWeek(r.booking_date));
      return rows;
    }

    /* ===================== Rendering ===================== */
    function renderList(){
      const rows = applyDateFilter(cache[statusFilter] || []);
      listEl.innerHTML = "";

      if(!rows.length){
        listEl.innerHTML = `<div class="empty">No bookings to show.</div>`;
        return;
      }

      rows.forEach(r => {
        const id = r.id ?? r.booking_id ?? "";
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>#${id}</div>
          <div class="dim">Client: ${r.client_id ?? "-"}</div>
          <div>
            <div><strong>${r.type ?? r.booking_type ?? "booking"}</strong></div>
            <div class="dim">${(r.item_details ?? r.notes ?? "-")}</div>
          </div>
          <div>${r.status ?? "-"}</div>
          <div>${fmtDate(r.booking_date)}</div>
          <div>${pigsText(r.pigs_ids)}</div>
          <div class="actions">
            ${statusFilter==="pending" ? actionButtons(id) : ""}
          </div>
        `;
        // row click -> open review modal (pending only)
        if (statusFilter === "pending") {
          row.addEventListener("click", (e) => {
            // ignore clicks on buttons (handled separately)
            if (e.target.closest("button")) return;
            openReview(r);
          });
        }
        // wire buttons
        row.querySelectorAll("button[data-act]").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const act = btn.dataset.act; // "approve" | "decline"
            // build a minimal booking object for the summary
            const booking = {
              id,
              client_id: r.client_id,
              type: r.type ?? r.booking_type,
              item_details: r.item_details ?? r.notes,
              booking_date: r.booking_date,
              pigs_ids: r.pigs_ids,
              status: r.status
            };
            openConfirm(act === "approve" ? "approved" : "declined", booking);
          });
        });

        listEl.appendChild(row);
      });
    }

    function updateBadges(){
      badges.pending.textContent  = (applyDateFilter(cache.pending).length).toString();
      badges.approved.textContent = (applyDateFilter(cache.approved).length).toString();
      badges.declined.textContent = (applyDateFilter(cache.declined).length).toString();
    }

    /* ===================== Review Modal ===================== */
    function openReview(bk){
      $("revId").value = bk.id ?? bk.booking_id ?? "";
      $("revSummary").textContent = `${bk.type ?? bk.booking_type ?? "booking"} ‚Äî ${(bk.item_details ?? bk.notes ?? "-")}`;
      $("revClient").textContent  = `Client: ${bk.client_id ?? "-"}, Booked: ${fmtDate(bk.booking_date)} | Pigs: ${pigsText(bk.pigs_ids)}`;
      $("reviewModal").style.display = "block";
    }
    function closeReview(){ $("reviewModal").style.display = "none"; }

    $("btnClose").addEventListener("click", closeReview);
    window.addEventListener("click", (e)=>{ if(e.target === $("reviewModal")) closeReview(); });

    // REPLACE: Approve from review modal
    $("btnApprove").addEventListener("click", ()=>{
      const id = $("revId").value;
      const booking = {
        id,
        client_id: $("revClient").textContent.replace(/^Client:\s*/,'').split(',')[0] || undefined,
        type: $("revSummary").textContent.split(' ‚Äî ')[0],
        item_details: $("revSummary").textContent.split(' ‚Äî ')[1],
        // we already show these in text, but grab the real ones from cache (more accurate):
        ...findBookingInCache(id)
      };
      openConfirm("approved", booking);
    });

    // REPLACE: Decline from review modal
    $("btnDecline").addEventListener("click", ()=>{
      const id = $("revId").value;
      const booking = {
        id,
        client_id: $("revClient").textContent.replace(/^Client:\s*/,'').split(',')[0] || undefined,
        type: $("revSummary").textContent.split(' ‚Äî ')[0],
        item_details: $("revSummary").textContent.split(' ‚Äî ')[1],
        ...findBookingInCache(id)
      };
      openConfirm("declined", booking);
    });

    // Helper to get the full row from cache for better summary
    function findBookingInCache(idStr){
      const idNum = Number(idStr);
      const all = [...(cache.pending||[]), ...(cache.approved||[]), ...(cache.declined||[])];
      const hit = all.find(b => Number(b.id ?? b.booking_id) === idNum);
      return hit ? {
        client_id: hit.client_id,
        type: hit.type ?? hit.booking_type,
        item_details: hit.item_details ?? hit.notes,
        booking_date: hit.booking_date,
        pigs_ids: hit.pigs_ids,
        status: hit.status
      } : {};
    }

    $("btnDecline").addEventListener("click", async ()=>{
      const id = Number($("revId").value);
      $("btnApprove").disabled = $("btnDecline").disabled = true;
      try{
        await decide(id, "declined");
        closeReview();
        await refreshAll();
        toast("Booking declined.");
      }catch(err){ alert(err.message||err); }
      finally{ $("btnApprove").disabled = $("btnDecline").disabled = false; }
    });

    /* ===================== Loaders ===================== */
    async function refreshAll(){
      // fetch three lists in parallel (no pagination)
      const [p,a,d] = await Promise.all([
        getBookings("pending").catch(()=>[]),
        getBookings("approved").catch(()=>[]),
        getBookings("declined").catch(()=>[]),
      ]);
      cache = { pending:p, approved:a, declined:d };
      updateBadges();
      renderList();
    }

    /* ===================== Wire filters ===================== */
    // Status tabs
    document.querySelectorAll("#statusTabs button").forEach(b=>{
      b.addEventListener("click", ()=>{
        document.querySelectorAll("#statusTabs button").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        statusFilter = b.dataset.status;
        renderList();
      });
    });

    // Date quick filters
    document.querySelectorAll("#dateTabs button").forEach(b=>{
      b.addEventListener("click", ()=>{
        document.querySelectorAll("#dateTabs button").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        dateFilter = b.dataset.range;
        updateBadges();
        renderList();
      });
    });

    // Logout
    document.getElementById("logout")?.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("token");
      window.location.href = "/Zhomepage/login.html";
    });

    /* ===================== Init ===================== */
    refreshAll();
  </script>
</body>
</html>
