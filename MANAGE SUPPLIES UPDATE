<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SwineTech | Manage Supplies</title>
  <link rel="stylesheet" href="/Admin/admin.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- UPDATED STYLES -->
  <style>
    /* ========== Tabs (match Pig Records) ========== */
    .tabs{margin:20px 0;display:flex;flex-wrap:wrap;gap:8px}
    .tab-btn{
      background:#f3f4f6;border:1px solid #e5e7eb;padding:10px 14px;border-radius:10px;
      cursor:pointer;font-weight:600;color:#374151
    }
    .tab-btn.active{background:#1a7f37;color:#fff;border-color:#1a7f37}

    /* ========== Carded table wrapper (same shell) ========== */
    .table-wrap{
      background:#fff;border-radius:16px;border:1px solid #eef2f6;
      box-shadow:0 10px 24px rgba(16,24,40,.06);overflow:hidden;margin-top:12px
    }

    /* ========== Modern table (identical rules) ========== */
    .admin-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    .admin-table thead th{
      position:sticky;top:0;z-index:1;background:#f8fafb;color:#374151;font-weight:700;
      padding:12px 14px;border-bottom:1px solid #e6ebf0;text-align:left;letter-spacing:.02em
    }
    .admin-table tbody td{padding:12px 14px;border-bottom:1px solid #eef2f6;color:#1f2937}
    .admin-table tbody tr:nth-child(even) td{background:#fbfdfe}
    .admin-table tbody tr:hover td{background:#f3f7fb}

    /* ========== Buttons (same family as Pig Records) ========== */
    .btn-add,.btn-edit,.btn-archive,.btn-restore,.btn-qty{
      padding:7px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600
    }
    .btn-add{background:#e8f5ff;color:#0b6bcb;border-color:#cde8ff}
    .btn-edit{background:#fff3d6;color:#a36200;border-color:#ffe3a3}
    .btn-archive{background:#ffe5e5;color:#b42318;border-color:#ffc9c9}
    .btn-restore{background:#e8f7ee;color:#1e7b4f;border-color:#c3ecd7}
    .btn-qty{background:#eef5ee;color:#2E7D32;border-color:#d7e8db}

    /* ========== Filters/controls row ========== */
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .controls input,.controls select{
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;outline:none
    }

    /* ========== Modals & forms (match Pig Records) ========== */
    .modal{display:none;position:fixed;inset:0;background:rgba(17,24,39,.55);z-index:50}
    .modal-content{
      background:#fff;margin:5% auto;max-width:680px;width:92%;border-radius:16px;padding:20px 22px;
      box-shadow:0 20px 40px rgba(16,24,40,.25);border:1px solid #eef2f6
    }
    .close{float:right;font-size:22px;cursor:pointer;color:#6b7280}
    .close:hover{color:#ef4444}

    .form-group{margin-bottom:12px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
    .form-group input,.form-group select{
      width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none
    }
    .form-group input:focus,.form-group select:focus{
      border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)
    }
    .btn-auth{background:#1a7f37;color:#fff;border:none;padding:10px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn-auth:hover{background:#15652c}

    /* ========== Responsive collapse (same behavior) ========== */
    @media (max-width: 880px){
      .admin-table thead{display:none}
      .admin-table,.admin-table tbody,.admin-table tr,.admin-table td{display:block;width:100%}
      .admin-table tr{background:#fff;border:1px solid #eef2f6;border-radius:12px;margin:10px 0;padding:10px}
      .admin-table td{border:0;padding:8px 4px}
      .admin-table td::before{
        content:attr(data-label);display:block;font-size:12px;color:#6b7280;margin-bottom:2px;text-transform:uppercase
      }
      .table-wrap{box-shadow:none;border:0;background:transparent}
    }

    /* ==== Feed totals card (sticky) ==== */
    .feed-stats {
      position: sticky; top: 8px; z-index: 2;
      background:#fff; border:1px solid #eef2f6; border-radius:16px;
      box-shadow:0 10px 24px rgba(16,24,40,.06);
      padding:12px 14px; margin:8px 0 10px;
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .feed-stats .title { font-weight:800; color:#0f172a; margin-right:6px; }

    .feed-chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:700;
      border:1px solid #e2e8f0; background:#f8fafc; color:#334155;
    }
    .feed-chip.ok    { background:#e9f7ef; color:#166534; border-color:#bfead4; }
    .feed-chip.warn  { background:#fff4e5; color:#92400e; border-color:#ffe6bf; }
    .feed-chip.low   { background:#fee2e2; color:#991b1b; border-color:#ffc7c7; }
    .feed-chip .unit { font-weight:600; opacity:.8; font-size:12px; }

    /* ==== Health supplies card (new, separate & sticky) ==== */
    .health-stats {
      position: static; /* was sticky; now fixed so it doesn't follow on scroll */
      top: auto; z-index: auto;
      background:#fff; border:1px solid #eef2f6; border-radius:16px;
      box-shadow:0 10px 24px rgba(16,24,40,.06);
      padding:12px 14px; margin:8px 0 10px;
    }
    .health-title { font-weight:800; color:#0f172a; margin-bottom:8px; font-size:1.25rem; letter-spacing:.02em; }
    .health-group { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0 10px; }
    .group-label { font-weight:800; color:#0f172a; margin-right:6px; }
    .health-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:700; border:1px solid #e2e8f0; background:#f8fafc; color:#334155; }
    .health-chip.ok   { background:#e9f7ef; color:#166534; border-color:#bfead4; }
    .health-chip.warn { background:#fff4e5; color:#92400e; border-color:#ffe6bf; }
    .health-chip.low  { background:#fee2e2; color:#991b1b; border-color:#ffc7c7; }
    .health-chip .unit { font-weight:600; opacity:.8; font-size:12px; }

    @media (max-width:880px){
      .feed-stats{ position:static; }
      .health-stats{ position:static; }
    }
  </style>

</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">üêñ SwineTech</div>
    <nav>
      <a href="dashboard-admin.html"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</a>
      <a href="admin-profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
      <a href="admin-manage-user-accounts.html"><i class="fa-solid fa-users"></i> Manage User Accounts</a>
      <a href="admin-manage-pig-records.html"><i class="fa-solid fa-piggy-bank"></i> Manage Pig Records</a>
      <a href="admin-manage-feeding-schedule.html"><i class="fa-solid fa-bowl-food"></i> Manage Feeding & Schedule</a>
      <a href="admin-manage-supplies.html" class="active"><i class="fa-solid fa-boxes-stacked"></i> Manage Supplies</a>
      <a href="admin-manage-sales-expenses-bookings.html"><i class="fa-solid fa-money-bill-trend-up"></i> Manage Sales, Expenses & Bookings</a>
      <a href="admin-manage-client-feedback-admin.html"><i class="fa-solid fa-comment-dots"></i> Manage Client Feedback</a>
      <a href="admin-generate-reports.html"><i class="fa-solid fa-file-lines"></i> Generate Reports</a>
      <a href="#" id="logoutLink" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard">
    <h1>Manage Supplies</h1>

    <div class="tabs">
      <button class="tab-btn active" onclick="showView('supplies')">üì¶ Supplies</button>
      <button class="tab-btn" onclick="showView('archived')">üìÇ Archived Supplies</button>
    </div>

    <!-- Supplies -->
    <section id="supplies" class="record-view active">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2 style="margin-right:auto;">Supplies Records</h2>
        <div class="controls">
          <button class="btn-add" onclick="openModal('addSupplyModal')">+ Add Supply</button>
          <button class="btn-add" onclick="reloadSupplies()">‚ü≥ Refresh</button>
          <input id="searchName" placeholder="Search by item name">
          <select id="sortCategory" title="Sort by category">
            <option value="">Sort: Category (A‚ÜíZ)</option>
            <option value="asc">Category ‚Üë</option>
            <option value="desc">Category ‚Üì</option>
          </select>
        </div>
      </div>

      <!-- FEED TOTALS (sticky card) -->
      <div id="feedStats" class="feed-stats" aria-live="polite">
        <div class="title">Feed Totals</div>
        <div class="feed-chip" id="chip-prestarter">Pre-starter: <span class="val">0</span><span class="unit">kg</span></div>
        <div class="feed-chip" id="chip-starter">Starter: <span class="val">0</span><span class="unit">kg</span></div>
        <div class="feed-chip" id="chip-grower">Grower: <span class="val">0</span><span class="unit">kg</span></div>
        <div class="feed-chip" id="chip-finisher">Finisher: <span class="val">0</span><span class="unit">kg</span></div>
      </div>

      <!-- HEALTH SUPPLIES (separate sticky card) -->
      <div id="healthStats" class="health-stats" aria-live="polite">
        <div class="health-title">Health Supplies</div>
        <div class="health-group">
          <span class="group-label">Vaccine Totals</span>
          <span id="vaccineChips"></span>
        </div>
        <div class="health-group">
          <span class="group-label">Medicine Totals</span>
          <span id="medicineChips"></span>
        </div>
      </div>

      <div class="table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th><th>Item Name</th><th>Category</th><th>Quantity</th>
              <th>Unit</th><th>Updated At</th><th>Updated By</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="supplyTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Archived Supplies (front-end only) -->
    <section id="archived" class="record-view">
      <h2>Archived Supplies</h2>
      <div class="table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th><th>Item Name</th><th>Category</th><th>Quantity</th>
              <th>Unit</th><th>Updated At</th><th>Updated By</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="archivedSupply"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Add Supply Modal -->
  <div id="addSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('addSupplyModal')">&times;</span>
      <h2>Add Supply</h2>
      <form id="addSupplyForm">
        <div class="form-group"><label>Item Name</label><input type="text" id="supplyName" required></div>
        <div class="form-group"><label>Category</label>
          <!-- UPDATED: vitamin removed, medicine added -->
          <select id="supplyCategory" required>
            <option>Feed</option><option>Medicine</option><option>Vaccine</option><option>Tool</option><option>Other</option>
          </select>
        </div>
        <div class="form-group"><label>Quantity</label><input type="number" id="supplyQuantity" required></div>
        <div class="form-group"><label>Unit</label>
          <!-- UPDATED units enum -->
          <select id="supplyUnit" required>
            <option>kg</option><option>pc</option><option>bottle</option><option>pack</option>
            <option>sack</option><option>bag</option><option>vial</option><option>sachet</option>
          </select>
        </div>
        <button type="submit" class="btn-auth">Save</button>
      </form>
    </div>
  </div>

  <!-- Edit Supply Modal -->
  <div id="editSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('editSupplyModal')">&times;</span>
      <h2>Edit Supply</h2>
      <form id="editSupplyForm">
        <input type="hidden" id="editSupplyId" />
        <div class="form-group"><label>Item Name</label><input type="text" id="editSupplyName" required></div>
        <div class="form-group"><label>Category</label>
          <!-- UPDATED: vitamin removed, medicine added -->
          <select id="editSupplyCategory" required>
            <option>Feed</option><option>Medicine</option><option>Vaccine</option><option>Tool</option><option>Other</option>
          </select>
        </div>
        <div class="form-group"><label>Quantity</label><input type="number" id="editSupplyQuantity" required></div>
        <div class="form-group"><label>Unit</label>
          <!-- UPDATED units enum -->
          <select id="editSupplyUnit" required>
            <option>kg</option><option>pc</option><option>bottle</option><option>pack</option>
            <option>sack</option><option>bag</option><option>vial</option><option>sachet</option>
          </select>
        </div>
        <button type="submit" class="btn-auth">Update</button>
      </form>
    </div>
  </div>

  <!-- Adjust Quantity Modal -->
  <div id="qtyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('qtyModal')">&times;</span>
      <h2>Adjust Quantity</h2>
      <form id="qtyForm">
        <input type="hidden" id="qtySupplyId" />
        <div class="form-group">
          <label>Quantity change (e.g., +10 or -5)</label>
          <input type="number" id="qtyDelta" step="1" required />
        </div>
        <button type="submit" class="btn-auth">Apply</button>
      </form>
    </div>
  </div>

  <!-- Archive Confirmation -->
  <div id="archiveModal" class="modal">
    <div class="modal-content">
      <h3>‚ö†Ô∏è Are you sure you want to archive this supply?</h3>
      <button id="archiveYesBtn">Yes, Archive</button>
      <button onclick="closeModal('archiveModal')">Cancel</button>
    </div>
  </div>

  <!-- Success/Error -->
  <div id="successModal" class="modal"><div class="modal-content"><h3 id="successMsg">‚úÖ Saved!</h3><button onclick="closeModal('successModal')">OK</button></div></div>
  <div id="errorModal" class="modal"><div class="modal-content"><h3 id="errorMsg">‚ùå Error</h3><button onclick="closeModal('errorModal')">OK</button></div></div>

  <!-- Use your shared API wrapper -->
  <script type="module">
    import { authApi, suppliesApi, getToken, clearToken } from "/_shared/api.js";

    // ---- UI helpers ----
    const $ = (id) => document.getElementById(id);
    function showView(v){
      document.querySelectorAll(".record-view").forEach(s=>s.classList.remove("active"));
      $(v).classList.add("active"); 
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelector(`.tab-btn[onclick="showView('${v}')"]`)?.classList.add("active");
    }
    function openModal(id){ $(id).style.display="block"; }
    function closeModal(id){ $(id).style.display="none"; }
    function success(msg="Saved!"){ $("successMsg").innerText = "‚úÖ " + msg; openModal("successModal"); }
    function fail(msg="Something went wrong"){ $("errorMsg").innerText = "‚ùå " + msg; openModal("errorModal"); }

    // ===== ENUMS =====
    // Categories: feed, medicine, vaccine, tool, other
    const CATEGORY_ENUM = new Set(["feed","medicine","vaccine","tool","other"]);

    // Units: enforced for new entries (legacy/custom still displayed)
    const UNIT_ENUM = new Set(["kg","pc","bottle","pack","sack","bag","vial","sachet"]);

    function fmtLocal(iso){
      if (!iso) return "";
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // gracefully accept id or supply_id, item_name or name
    function normalizeSupply(s, me){
      const id = Number(s.supply_id ?? s.id ?? 0);
      return {
        id,
        item_name: s.item_name ?? s.name ?? "",
        category:  (s.category ?? "").toString(),
        quantity:  Number(s.quantity ?? 0),
        unit:      (s.unit ?? "").toString(),
        updated_at: s.updated_at ?? s.created_at ?? "",
        updated_by: s.updated_by ?? null,
        // derive display fields
        updated_by_name: (s.updated_by != null && me && Number(s.updated_by) === Number(me.user_id))
          ? (me.name ?? me.full_name ?? me.username ?? me.email ?? `#${s.updated_by}`)
          : (s.updated_by != null ? `#${s.updated_by}` : "-"),
      };
    }

    /* ================= FEED TOTALS ================= */
    const FEED_THRESHOLDS_KG = {
      prestarter: 100,
      starter:    150,
      grower:     200,
      finisher:   200,
    };

    function detectStage(itemNameRaw) {
      const s = String(itemNameRaw || "").toLowerCase();
      if (/\bpre[\s-]?starter\b/.test(s)) return "prestarter";
      if (/\bstarter\b/.test(s))         return "starter";
      if (/\bgrower\b/.test(s))          return "grower";
      if (/\bfinisher\b/.test(s))        return "finisher";
      return null;
    }

    function computeFeedTotals() {
      const totals = { prestarter: 0, starter: 0, grower: 0, finisher: 0 };
      for (const r of suppliesAll) {
        const cat = String(r.category || "").toLowerCase();
        if (cat !== "feed") continue;
        const stage = detectStage(r.item_name || r.name);
        if (!stage) continue;
        const qty = Number(r.quantity || 0);
        totals[stage] += qty;
      }
      return totals;
    }

    function renderFeedStats() {
      const totals = computeFeedTotals();
      const chips = [
        { id: "chip-prestarter", key: "prestarter", label: "Pre-starter" },
        { id: "chip-starter",    key: "starter",    label: "Starter"     },
        { id: "chip-grower",     key: "grower",     label: "Grower"      },
        { id: "chip-finisher",   key: "finisher",   label: "Finisher"    },
      ];

      for (const c of chips) {
        const el = document.getElementById(c.id);
        if (!el) continue;
        const valNode = el.querySelector(".val");
        if (valNode) valNode.textContent = totals[c.key].toLocaleString();

        const thr = FEED_THRESHOLDS_KG[c.key] ?? 0;
        el.classList.remove("ok", "warn", "low");
        if (totals[c.key] <= Math.max(thr * 0.5, 1)) {
          el.classList.add("low");
          el.title = `${c.label} low (‚â§ ${Math.round(thr*0.5)} kg)`;
        } else if (totals[c.key] <= thr) {
          el.classList.add("warn");
          el.title = `${c.label} nearing low (‚â§ ${thr} kg)`;
        } else {
          el.classList.add("ok");
          el.title = `${c.label} healthy level`;
        }
      }
    }

    /* ================= HEALTH SUPPLIES (Medicine/Vaccine) =================
       - Group by UNIT per category
       - Threshold coloring per-unit (similar logic to feed)
       - Defaults chosen conservatively; tweak as needed
    ====================================================================== */
    const HEALTH_UNITS_ORDER = ["bottle","vial","pack","sachet","bag","sack","pc","kg"]; // display order

    // Per-unit thresholds (apply to both vaccine and medicine). Adjust freely.
    const HEALTH_THRESHOLDS_UNIT = {
      bottle: 10,
      vial:   20,
      pack:   10,
      sachet: 50,
      bag:    5,
      sack:   5,
      pc:     10,
      kg:     10,
      // unknown units fallback handled below
    };

    function computeHealthTotals() {
      // returns: { vaccine: Map(unit->sum), medicine: Map(unit->sum) }
      const out = { vaccine: new Map(), medicine: new Map() };
      for (const r of suppliesAll) {
        const cat = String(r.category || "").toLowerCase();
        if (cat !== "vaccine" && cat !== "medicine") continue;
        const unit = String(r.unit || "").toLowerCase() || "pc"; // fallback
        const qty  = Number(r.quantity || 0);
        const map  = out[cat];
        map.set(unit, (map.get(unit) || 0) + qty);
      }
      return out;
    }

    function chipHtml(label, val, unit, levelClass, titleText){
      return `<span class="health-chip ${levelClass}" title="${titleText}">${label}: <span class="val">${val.toLocaleString()}</span> <span class="unit">${unit}</span></span>`;
    }

    function renderHealthGroup(containerId, unitMap, groupLabel){
      const host = document.getElementById(containerId);
      if (!host) return;
      // Sort units by our display order; unknowns at the end alpha
      const entries = Array.from(unitMap.entries());
      entries.sort((a,b)=>{
        const ua = a[0], ub = b[0];
        const ia = HEALTH_UNITS_ORDER.indexOf(ua);
        const ib = HEALTH_UNITS_ORDER.indexOf(ub);
        if (ia !== -1 && ib !== -1) return ia - ib;
        if (ia !== -1) return -1;
        if (ib !== -1) return 1;
        return ua.localeCompare(ub);
      });

      const html = entries.map(([unit, sum]) => {
        const thr = HEALTH_THRESHOLDS_UNIT[unit] ?? 10; // default if unknown
        let level = "ok", title = `${groupLabel} healthy level`;
        if (sum <= Math.max(thr*0.5, 1)) { level = "low";  title = `${groupLabel} low (‚â§ ${Math.round(thr*0.5)} ${unit})`; }
        else if (sum <= thr)              { level = "warn"; title = `${groupLabel} nearing low (‚â§ ${thr} ${unit})`; }
        return chipHtml(`${groupLabel} ${unit}`, sum, unit, level, title);
      }).join(" ");

      host.innerHTML = html || `<span class="health-chip" title="No items">No ${groupLabel.toLowerCase()} recorded</span>`;
    }

    function renderHealthStats(){
      const { vaccine, medicine } = computeHealthTotals();
      renderHealthGroup("vaccineChips", vaccine, "Vaccine");
      renderHealthGroup("medicineChips", medicine, "Medicine");
    }

    /* Recompute after any data change */
    function recomputeTotalsAfterRender() {
      renderFeedStats();
      renderHealthStats();
    }

    /* ========= Cross-page hook for Feeding Logs ========= */
    window.onFeedingLogged = async function(stageName, qtyKg) {
      try {
        const stage = detectStage(stageName);
        const qty = Number(qtyKg);
        if (!stage || !qty || qty <= 0) return;
        await reloadSupplies();
        const candidate = suppliesAll.find(r =>
          String(r.category || "").toLowerCase() === "feed" &&
          detectStage(r.item_name || r.name) === stage
        );
        if (!candidate) { console.warn(`No FEED item found for stage ${stage}`); return; }
        await suppliesApi.adjustQty(candidate.supply_id ?? candidate.id, -qty);
        await reloadSupplies();
        success(`Deducted ${qty} kg from ${stageName} feed`);
      } catch (err) {
        fail(asMessage(err) || "Failed to deduct feed after feeding log");
      }
    };

    // central error reader: your backend uses {error:{message}}
    function asMessage(err){
      if (!err) return "Unknown error";
      if (typeof err === "string") return err;
      if (err.error && err.error.message) return err.error.message;
      if (err.detail && typeof err.detail === "string") return err.detail;
      try { return JSON.parse(err.message)?.error?.message || err.message; } catch { return err.message || "Error"; }
    }

    let suppliesAll = []; // cache of normalized supplies

    // ---- state ----
    let me = null; // current user (for updated_by)
    let archiveTarget = null; // DOM tr

    // ---- render ----
    function trForSupply(s){
      const n = normalizeSupply(s, me);
      const tr = document.createElement("tr");
      tr.dataset.id = n.id;
      tr.innerHTML = `
        <td>${n.id}</td>
        <td>${escapeHtml(n.item_name)}</td>
        <td>${escapeHtml(n.category)}</td>
        <td>${Number(n.quantity)}</td>
        <td>${escapeHtml(n.unit)}</td>
        <td>${fmtLocal(n.updated_at)}</td>
        <td>${escapeHtml(n.updated_by_name)}</td>
        <td>
          <button class="btn-qty"    data-id="${n.id}">Adjust Qty</button>
          <button class="btn-edit"   data-id="${n.id}">Edit</button>
          <button class="btn-archive" data-id="${n.id}">Archive</button>
        </td>`;

      tr.querySelector(".btn-edit").onclick = () => openEditModalFromRow(tr);
      tr.querySelector(".btn-archive").onclick = () => { archiveTarget = tr; openModal("archiveModal"); };
      tr.querySelector(".btn-qty").onclick = () => openQtyModal(tr);
      return tr;
    }

    function escapeHtml(s){ return (""+s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    async function reloadSupplies(){
      try{
        const raw = await suppliesApi.list();
        suppliesAll = Array.isArray(raw) ? raw : (raw?.items ?? raw?.data ?? []);
        renderSupplies();
        recomputeTotalsAfterRender();
      }catch(e){
        fail(asMessage(e) || "Failed to load supplies");
      }
    }

    function renderSupplies(){
      let rows = suppliesAll.slice();
      const q = ($("searchName")?.value || "").trim().toLowerCase();
      if (q) rows = rows.filter(s => (s.item_name ?? s.name ?? "").toLowerCase().includes(q));
      const sort = $("sortCategory")?.value || "";
      if (sort === "asc" || sort === "desc") {
        const dir = sort === "asc" ? 1 : -1;
        rows.sort((a,b)=>{
          const ca = (a.category ?? "").toLowerCase();
          const cb = (b.category ?? "").toLowerCase();
          if (ca < cb) return -1 * dir;
          if (ca > cb) return  1 * dir;
          return 0;
        });
      }
      const tbody = $("supplyTable");
      tbody.innerHTML = "";
      rows.forEach(s => tbody.appendChild(trForSupply(s)));
    }

    // hook live search/sort
    $("searchName")?.addEventListener("input", renderSupplies);
    $("sortCategory")?.addEventListener("change", renderSupplies);

    // ---- add ----
    $("addSupplyForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const body = {
        item_name: $("supplyName").value.trim(),
        category: $("supplyCategory").value.trim().toLowerCase(),
        quantity: Number($("supplyQuantity").value),
        unit: $("supplyUnit").value.trim().toLowerCase(),
      };
      // VALIDATE to backend expectations
      if (!Number.isInteger(body.quantity) || body.quantity < 0) return fail("Quantity must be an integer ‚â• 0");
      if (!CATEGORY_ENUM.has(body.category)) return fail("Category must be one of: feed, medicine, vaccine, tool, other");
      if (!UNIT_ENUM.has(body.unit)) return fail("Unit must be one of: kg, pc, bottle, pack, sack, bag, vial, sachet");
      if(!body.item_name) return fail("Please fill all fields correctly");

      try{
        await suppliesApi.create(body);   // POST /supplies
        $("addSupplyForm").reset();
        closeModal("addSupplyModal");
        success("Supply added");
        await reloadSupplies();
      }catch(e){
        fail(asMessage(e) || "Create failed");
      }
    });

    // ---- edit ----
    function openEditModalFromRow(tr){
      const cells = tr.cells;
      $("editSupplyId").value       = tr.dataset.id;
      $("editSupplyName").value     = cells[1].innerText;
      $("editSupplyCategory").value = capitalizeFirst(cells[2].innerText.toLowerCase());
      $("editSupplyQuantity").value = cells[3].innerText;
      $("editSupplyUnit").value     = cells[4].innerText.toLowerCase();
      openModal("editSupplyModal");
    }

    function capitalizeFirst(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    $("editSupplyForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const id = $("editSupplyId").value;
      const body = {
        item_name: $("editSupplyName").value.trim(),
        category: $("editSupplyCategory").value.trim().toLowerCase(),
        quantity: Number.parseInt($("editSupplyQuantity").value,10),
        unit: $("editSupplyUnit").value.trim().toLowerCase(),
      };
      if(!id) return fail("Missing id");
      if (!Number.isInteger(body.quantity) || body.quantity < 0) return fail("Quantity must be an integer ‚â• 0");
      if (!CATEGORY_ENUM.has(body.category)) return fail("Category must be one of: feed, medicine, vaccine, tool, other");
      if (!UNIT_ENUM.has(body.unit)) return fail("Unit must be one of: kg, pc, bottle, pack, sack, bag, vial, sachet");
      if(!body.item_name) return fail("Please fill all fields correctly");

      try{
        await suppliesApi.update(id, body);               // PUT /supplies/{id}
        closeModal("editSupplyModal");
        success("Supply updated");
        await reloadSupplies();
      }catch(e){
        fail(asMessage(e) || "Update failed");
      }
    });

    // ---- adjust quantity ----
    function openQtyModal(tr){
      $("qtySupplyId").value = tr.dataset.id;
      $("qtyDelta").value = "";
      openModal("qtyModal");
    }
    $("qtyForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const id = $("qtySupplyId").value;
      const delta = Number.parseInt($("qtyDelta").value, 10);
      if(!id || !Number.isInteger(delta) || delta === 0){ return fail("Enter a non-zero integer"); }

      try{
        await suppliesApi.adjustQty(id, delta);  // PATCH /supplies/{id}/adjust-qty
        closeModal("qtyModal");
        success("Quantity adjusted");
        await reloadSupplies();
      }catch(e){
        const msg = asMessage(e);
        if (/negative|insufficient|below/i.test(msg)) return fail("Adjustment rejected: would result in negative inventory");
        fail(msg || "Adjust failed");
      }
    });

    // ---- archive (front-end only move) ----
    $("archiveYesBtn").onclick = ()=>{
      if(!archiveTarget) return closeModal("archiveModal");
      const clone = archiveTarget.cloneNode(true);
      const actions = clone.querySelector("td:last-child");
      actions.innerHTML = `<button class="btn-restore">Restore</button>`;
      actions.querySelector(".btn-restore").onclick = ()=>{
        const back = clone.cloneNode(true);
        const id = clone.dataset.id;
        const last = back.querySelector("td:last-child");
        last.innerHTML = `
          <button class=\"btn-qty\" data-id=\"${id}\">Adjust Qty</button>
          <button class=\"btn-edit\" data-id=\"${id}\">Edit</button>
          <button class=\"btn-archive\" data-id=\"${id}\">Archive</button>`;
        back.querySelector(".btn-edit").onclick = () => openEditModalFromRow(back);
        back.querySelector(".btn-archive").onclick = () => { archiveTarget = back; openModal("archiveModal"); };
        back.querySelector(".btn-qty").onclick = () => openQtyModal(back);
        $("supplyTable").appendChild(back);
        clone.remove();
        recomputeTotalsAfterRender();
      };
      $("archivedSupply").appendChild(clone);
      archiveTarget.remove();
      archiveTarget = null;
      closeModal("archiveModal");
      success("Archived (local only)");
      recomputeTotalsAfterRender();
    };

    // ---- bootstrap ----
    async function init(){
      if(!getToken()){ return (window.location.href = "/Zhomepage/login.html"); }
      try{ me = await authApi.me(); }catch(e){ clearToken(); return (window.location.href = "/Zhomepage/login.html"); }
      await reloadSupplies();
    }

    window.addEventListener("click",(e)=>{
      document.querySelectorAll(".modal").forEach(m => { if(e.target === m) m.style.display = "none"; });
    });

    Object.assign(window, { showView, openModal, closeModal, reloadSupplies });

    init();

    // --- Logout: clear token and redirect to login
    document.getElementById("logoutLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      clearToken();
      window.location.href = "/Zhomepage/login.html";
    });

  </script>
</body>
</html>
